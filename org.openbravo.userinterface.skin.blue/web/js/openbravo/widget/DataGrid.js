dojo.provide("openbravo.widget.DataGrid");dojo.require("dijit._Widget");dojo.require("dojox.collections.Dictionary");dojo.require("dojox.data.dom");function createTextCellElement(e){var d=function(f){if(dojo&&!dojo.hasClass(this,"DataGrid_Body_Cell_hover")&&!dojo.hasClass(this,"DataGrid_Body_Cell_clicked")){dojo.addClass(this,"DataGrid_Body_Cell_hover");
}};var b=function(f){if(dojo&&dojo.hasClass(this,"DataGrid_Body_Cell_hover")){dojo.removeClass(this,"DataGrid_Body_Cell_hover",false);}};var c=document.createElement("nobr");c.className=openbravo.widget.DataGrid.Column.prototype.DEFAULT_CLASS;dojo.addClass(c,e.className);c.onmouseover=d;c.onmouseout=b;
openbravo.widget.DataGrid.html.disableSelection(c);var a=document.createTextNode("");c.appendChild(a);if(e.visible){c.style.width=e.width;}else{c.style.display="none";}return c;}dojo.declare("openbravo.widget.DataGrid",[dijit._Widget],{structureUrl:"",dataUrl:"",updatesUrl:"",calculateNumRows:false,numRows:20,offset:0,sortCols:"",sortDirs:"",editable:true,sortable:true,onInvalidValue:alert,onScroll:function(){},onGridLoad:function(){},defaultRow:0,showLineNumbers:"true",lineNoColumnWidth:"40px",lineNoColumnTitle:"#",lineNoColumnClass:"DataGrid_Body_LineNoCell",lineNoColumnHeaderClass:"DataGrid_Header_LineNoCell",bufferSize:7,maxWidth:"100%",percentageWidthRelativeToId:"body",isFirstLoad:true,hasBeenResized:false,offsetBeforeResize:0,multipleRowSelection:true,templateString:"<div></div>",templateCssPath:null,backendPageSize:0,getBackendPageSize:function(){return this.backendPageSize;
},postMixInProperties:function(a,c,b){setCalloutProcessing(true);if(this.updatesUrl==""){this.updatesUrl=dataUrl;}this.selectedRows=new openbravo.widget.DataGrid.IndexedRows();if(this.calculateNumRows==true){this.numRows=calculateNumRows();}this.editor=null;this.editing=false;this.editingCell=null;this.tableNode=null;
this.editingRow=null;this.selectedCell=-1;this.locked=false;this.lastHoveredColumn=null;this.lastAddition="";this.validators=[];this.requestParams=[];this.visibleRows=this.numRows;this.visibleRowsMax=this.numRows;this.scrollWidth=openbravo.widget.DataGrid.html.getScrollbar().width;if(this.onInvalidValue==alert){this.onInvalidValue=function(d){alert(d);
};}this.savingInterface={save:dojo.hitch(this,"saveCell"),cancel:dojo.hitch(this,"cancelEdit"),lockGrid:dojo.hitch(this,function(){this.locked=true;}),unlockGrid:dojo.hitch(this,function(){this.locked=false;this.setFocus();}),dataUrl:this.dataUrl,updatesUrl:this.updatesUrl};this.errorHandler={handleError:dojo.hitch(this,"handleUpdateError")};
this.columns=new openbravo.widget.DataGrid.Columns();this.numberOfResizes=0;this.requestStructure();},postCreate:function(){var c=document.createElement("tr");c.className="DataGrid_Body_Row";var a=dojo.style(c,"height","15px");this.domNode.style.height=(28)*(this.numRows+1)+"px";var d=this.maxWidth.indexOf("%");
if(d>0){this.proportion=this.maxWidth.substr(0,d)/100;var b=this.setMaxWidth();this.domNode.style.width=b+8+"px";}},requestStructure:function(b,c,d){var f=new openbravo.widget.DataGrid.Parser(this);var a=dojo.hitch(f,"ajaxUpdate");var e={url:this.structureUrl,handler:a,method:"GET",handleAs:"xml"};openbravo.widget.DataGrid.io.asyncCall(e,{});
},editCell:function(b){if(this.editing){this.saveCell();}if(!this.editing&&this.editable){var e=b.parentNode;var d=dojo.indexOf(b.parentNode.cells,b);var c=this.columns.get(d);if(c.readonly){return;}var f=this.getCurrentOffset()+e.rowIndex;var a=this.editingRow&&this.editingRow.offset!=f;if(!this.editingRow||a){this.editingRow=this.buffer.getRow(f);
}this.editingRow.setStatus(this.editingRow.EDITING);this.editor=c.renderEditor(b,this.editingRow,this.savingInterface);openbravo.widget.DataGrid.html.enableSelection(b);this.editingCell=b;this.editing=true;}},saveCell:function(){var j=this.editingCell;if(!j){return;}var h=dojo.indexOf(j.parentNode.cells,j);
var e=this.columns.get(h);var b=this.editingRow.getValue(e.index);var d=this.editor.getValue();if(d==b){this.cancelEdit();return true;}var g=e.type.validate(d);if(g){this.editingRow.setValue(e.name,d);if(e.invalidates.length>0){for(var f=0;f<e.invalidates.length;f++){var c=this.columns.get(e.invalidates[f]).index;
this.editingRow.setValue(e.invalidates[f],"");openbravo.widget.DataGrid.html.clearElement(j.parentNode.childNodes[c]);}}if(e.sync){this.saveRow(true);}this.hideEditor(d);return true;}else{var a="Invalid value";this.onInvalidValue(a);this.editor.setFocus();return false;}},saveRow:function(e){var f=this.editingRow;
if(!f.modified&&!f.error){return true;}e=e==true;var d=f.checkFields();if(d.length>0){if(!e){this.onInvalidValue("A required field is empty");var c=d[0];var a=this.isVisible(f.offset);var b=dojo.hitch(this,function(){this.options.onRefreshComplete.remove(b);this.editCell(f.rowNode.cells[c]);});if(!a){this.options.onRefreshComplete.push(b);
this.goToRow(f.offset);}else{b();}}}else{f.validate(this.validators);}if(!f.error){f.sendRow(this.updatesUrl);return true;}else{return false;}},createRowObject:function(a){return new openbravo.widget.DataGrid.Row(a,this.columns,this.options,this.errorHandler,dojo.hitch(this,"isVisible"));},handleUpdateError:function(k,l){var b=document.createElement("div");
var c=document.createElement("form");var m=document.createElement("table");var e=document.createElement("tbody");var a=document.createElement("tr");var n=document.createElement("td");dojo.addClass(n,"messageDialogTitle");n.appendChild(document.createTextNode(k));a.appendChild(n);var d=document.createElement("tr");
var i=document.createElement("td");dojo.addClass(i,"messageDialogText");i.appendChild(document.createTextNode(l));i.innerHTML=i.innerHTML+"<br/><br/>";d.appendChild(i);var h=document.createElement("tr");var j=document.createElement("td");j.align="center";var f=document.createElement("input");f.type="button";
f.value="OK";dojo.addClass(f,"dialogButton");j.appendChild(f);h.appendChild(j);e.appendChild(a);e.appendChild(d);e.appendChild(h);m.appendChild(e);c.appendChild(m);b.appendChild(c);var o={bgColor:"white",bgOpacity:"0.5"};var g=dojo.widget.createWidget("dojo:Dialog",o,c);dojo.connect(f,"onclick",g,"hide");
dojo.connect(g,"hide",g,"destroy");g.show();},cancelEdit:function(){if(!this.editing){return;}var a=this.editingRow.getValue(this.columns.getIdentifier().index);if(this.options.failedRows.contains(a)){this.editingRow.setStatus(this.editingRow.ERROR);}else{this.editingRow.setStatus(this.editingRow.CORRECT);
}this.hideEditor(this._getEditingCellContent(this.editingCell));},hideEditor:function(a){var c=a;if(c&&typeof c=="string"){a=c.split(" ").join("&nbsp;");}var e=this.editingCell;if(!e){return;}openbravo.widget.DataGrid.html.disableSelection(e);this.editing=false;this.editingCell=null;var b=null;var d=dojo.indexOf(e.parentNode.cells,e);
b=this.columns.get(d);if(b&&b.type.name=="url"&&a!=""){e.innerHTML='<a href="'+a+'" target=_blank><img src="../web/js/openbravo/templates/popup1.gif" border="0" title="Link" alt="Link"></a>&nbsp;'+a;}if(b&&b.type.name=="img"&&a!=""){e.innerHTML="<a onclick=\"openPopUp('"+a+"', 'Image', '70%', '70%'); return false;\" href=\""+a+'"><img src="'+a+'" border="0" height="15px"></a>';
}else{e.innerHTML=a;}},_getEditingCellContent:function(a){var c=dojo.indexOf(a.parentNode.cells,a);var b=this.columns.get(c);return this.editingRow.getValue(b.index);},showSelection:function(){var d=this.selectedRows.count();var g=this.getCurrentOffset();var f=false;if(d>0){var c=this.selectedRows.getLastSelected().id;
}for(var e=0;e<this.numRows;e++){var b=this.buffer.getRow(g+e);if(!b){continue;}if(d>0&&this.selectedRows.contains(b.getValue(this.columns.getIdentifier().index))||b.isNewRow){if(isGridFocused){openbravo.widget.DataGrid.html.prereplaceClass(this.tableNode.rows[e],"DataGrid_Body_Row_focus",e%2==0?"DataGrid_Body_Row_Even":"DataGrid_Body_Row_Odd");
}else{openbravo.widget.DataGrid.html.prereplaceClass(this.tableNode.rows[e],"DataGrid_Body_Row_selected",e%2==0?"DataGrid_Body_Row_Even":"DataGrid_Body_Row_Odd");}for(var a=0;a<this.columns.count();a++){if(!dojo.hasClass(this.tableNode.rows[e].cells[a],"DataGrid_Body_Cell_selected")){dojo.addClass(this.tableNode.rows[e].cells[a],"DataGrid_Body_Cell_selected");
}if(dojo.hasClass(this.tableNode.rows[e].cells[a],"DataGrid_Body_Cell_clicked")){dojo.removeClass(this.tableNode.rows[e].cells[a],"DataGrid_Body_Cell_clicked");}}d--;if(this.selectedCell>=0&&!f){if(b.getValue(this.columns.getIdentifier().index)==c){if(!dojo.hasClass(this.tableNode.rows[e].cells[this.selectedCell],"DataGrid_Body_Cell_clicked")){dojo.addClass(this.tableNode.rows[e].cells[this.selectedCell]," DataGrid_Body_Cell_clicked");
}f=true;}}}else{if(isGridFocused){openbravo.widget.DataGrid.html.prereplaceClass(this.tableNode.rows[e],e%2==0?"DataGrid_Body_Row_Even":"DataGrid_Body_Row_Odd","DataGrid_Body_Row_focus");}else{openbravo.widget.DataGrid.html.prereplaceClass(this.tableNode.rows[e],e%2==0?"DataGrid_Body_Row_Even":"DataGrid_Body_Row_Odd","DataGrid_Body_Row_selected");
}for(var a=0;a<this.columns.count();a++){if(dojo.hasClass(this.tableNode.rows[e].cells[a],"DataGrid_Body_Cell_selected")){dojo.removeClass(this.tableNode.rows[e].cells[a],"DataGrid_Body_Cell_selected");}if(dojo.hasClass(this.tableNode.rows[e].cells[a],"DataGrid_Body_Cell_clicked")){dojo.removeClass(this.tableNode.rows[e].cells[a],"DataGrid_Body_Cell_clicked");
}}}}},handleScroll:function(a){if(this.editing){this.cancelEdit();}},isVisible:function(c){var b=this.getCurrentOffset();var a=b+this.numRows;return b<=c&&c<=a;},_getContainerCell:function(c){var a=false;try{a=(c.nodeName.toLowerCase()=="nobr");}catch(b){a=false;}while(c&&(!dojo.hasClass(c,"DataGrid_Body_Cell_hover")||a)){c=openbravo.widget.DataGrid.html.getParentByType(c,"td");
if(c&&!dojo.hasClass(c,"DataGrid_Body_Cell_hover")){c=c.parentNode;}try{a=(c.nodeName.toLowerCase()=="nobr");}catch(b){a=false;}}return c;},cellDoubleClicked:function(b){isClickOnGrid=true;focusGrid();currentWindowElementType="grid";setWindowElementFocus("grid_table_dummy_input","id");var c=b.target;
var a=c.nodeName.toLowerCase()=="td";if(!a){c=this._getContainerCell(c);a=(c.nodeName.toLowerCase()=="nobr");}if(this.editable&&c&&c!=this.editingCell){this.editCell(c);}else{if(c){onRowDblClick(c);}}},cellClicked:function(c){isClickOnGrid=true;focusGrid();currentWindowElementType="grid";setWindowElementFocus("grid_table_dummy_input","id");
if(this.locked){return;}this.lastHoveredColumn=null;var b=(c.target.nodeName.toLowerCase()=="td");var a=c.target;if(!b){a=this._getContainerCell(a);b=(c.target.nodeName.toLowerCase()=="nobr");}if(!a){return;}var d=a.parentNode;var f=this.getCurrentOffset()+d.rowIndex;var e=true;if(this.editing&&a&&this.editingCell!=a){e=this.saveCell();
}if(this.editingRow&&this.editingRow.offset!=f&&b&&e){e=this.saveRow();}if(b&&(!this.editingRow||!this.editingRow.error)&&e){this.handleSelection(c);}checkAttachmentIconRelation();},handleSelection:function(n){var f=(n.target.nodeName.toLowerCase()=="td");var b=n.target;if(!f){b=this._getContainerCell(b);
}var d=b.parentNode;if(!d){return;}if((!n.ctrlKey&&!n.shiftKey)||this.multipleRowSelection==false){this.selectedRows.clear();}var s=this.getCurrentOffset()+d.rowIndex;var e=this.buffer.getRow(s);if(!e){return;}this.tableNode.focus();if(n.shiftKey){if(this.selectedRows.count()>0){var m=this.getCurrentOffset();
var l=m+this.numRows;var k=this.selectedRows.getLastSelected();var c=k.offset;var a=e.offset;var o=(c>=a?a:c);var r=(c>=a?c:a);if(m<=c&&c<l&&m<=a&&a<l){var g=r-m;for(var q=(o-m);q<g;q++){var u=this.buffer.getRow(m+q);this.addSelectedRow(u.getValue(this.columns.getIdentifier().name),m+q);}}else{var t={url:this.dataUrl,handler:dojo.hitch(this,"idsReceived",o),method:"POST",handleAs:"xml"};
var p=[];if(this.requestParams){for(var j in this.requestParams){p[j]=this.requestParams[j];}}p["action"]="getIdsInRange";p["minOffset"]=o;p["maxOffset"]=r;if(this.sortCols){p["sort_cols"]=this.sortCols;p["sort_dirs"]=this.sortDirs;}openbravo.widget.DataGrid.io.asyncCall(t,p);}}}if(n.ctrlKey&&dojo.hasClass(d,"DataGrid_Body_Row_focus")){this.selectedRows.remove(e.getValue(this.columns.getIdentifier().name));
}else{var h={id:e.getValue(this.columns.getIdentifier().name),offset:s};this.selectedRows.add(h);this.selectedCell=dojo.indexOf(b.parentNode.cells,b);}this.showSelection();if(n.shiftKey||n.ctrlKey){dojo.stopEvent(n);}},addSelectedRow:function(c,b){var a={id:c,offset:b};this.selectedRows.add(a);},idsReceived:function(g,f,l){var c=f.getElementsByTagName("xml-rangeid");
var d=c[0].getElementsByTagName("status");if(d.length>0){var h=d[0].getElementsByTagName("type");var j=d[0].getElementsByTagName("title");var k=d[0].getElementsByTagName("description");if(dojox.data.dom.textContent(h[0]).toUpperCase()!="HIDDEN"){try{renderMessageBox(dojox.data.dom.textContent(h[0]),dojox.data.dom.textContent(j[0]),dojox.data.dom.textContent(k[0]));
}catch(b){alert(dojox.data.dom.textContent(j[0])+":\n"+dojox.data.dom.textContent(k[0]));}}}var a=c[0].getElementsByTagName("id");for(var e=0;e<a.length;e++){this.addSelectedRow(dojox.data.dom.textContent(a[e]),g+e);}this.showSelection();},enterKeyPressed:function(){if(this.editing){this.saveCell();setTimeout(dojo.hitch(this,function(){this.setFocus();
}),200);}else{var a=this.selectedRows.getLastSelected();if(a!=null){var b=a.offset;var d=this.getCurrentOffset();if(b<d||b>=(d+this.numRows)){this.goToRow(b);}else{var c=b-this.getCurrentOffset();if(c>=0){this.editCell(this.tableNode.rows[c].cells[this.selectedCell]);}}}}},getStartEditingFunction:function(b){var c=this;
var a=dojo.hitch(c,"startEditingCell",b,a);return a;},startEditingCell:function(b,a){this.options.onRefreshComplete.remove(a);var d=this.getCurrentOffset();var c=b-d;if(c>=0){this.editCell(this.tableNode.rows[c].cells[this.selectedCell]);}},_getKeyMapping:function(){if(!this.keyMapping){var b=dojo.keys;
this.keyMapping=[];var a=this.keyMapping;}return this.keyMapping;},_getKeyEventsToStop:function(){if(!this.keyEventsToStop){var a=dojo.keys;this.keyEventsToStop=[a.KEY_UP_ARROW,a.KEY_DOWN_ARROW,a.KEY_HOME,a.KEY_END];}return this.keyEventsToStop;},_allowedKeys:function(){var a=dojo.keys;return[a.KEY_ENTER,a.KEY_ESCAPE];
},keyPressed:function(a){if(this.locked){return;}var b=dojo.keys;var e=a.keyCode;var d=openbravo.widget.DataGrid.html.inArray(this._getKeyEventsToStop(),e);if(this.editing&&!openbravo.widget.DataGrid.html.inArray(this._allowedKeys(),e)){return;}var c=this._getKeyMapping()[e];if(c){c();}if(d||e==b.KEY_ENTER&&dojo.isIE){dojo.stopEvent(a);
}},onPageUnload:function(a){if(this.editingRow){this.saveRow();}},goToLeftCell:function(){this.moveSelectedCell(-1);},goToRightCell:function(){this.moveSelectedCell(1);},moveSelectedCell:function(c){if(!this.editing){var b=false;var a=this.selectedCell+c;while(a>=0&&a<this.columns.count()&&!b){b=this.checkCell(a);
if(!b){a+=c;}}if(b){this.selectedCell=a;this.showSelection();dijit.scrollIntoView(this.tableNode.rows[0].cells[this.selectedCell]);}}},checkCell:function(b){if(b>=0&&b<this.columns.count()){var a=this.columns.get(b);return a.visible;}else{return false;}},hoverCellHeader:function(k){if(!dojo.hasClass(k.target,"DataGrid_Header_Cell_hover")){dojo.addClass(k.target,"DataGrid_Header_Cell_hover");
}var e=openbravo.widget.DataGrid.html.getParentByType(k.target,"th");var j=dojo.indexOf(e.parentNode.cells,e);var c=this.columns.get(j);this.drawTotalNumber("",e);if(c!=null&&this.selectedRows.count()>0){var f=c.index;if(!this.lastHoveredColumn||this.lastHoveredColumn.index!=f){var g=c.type.name;if(g=="integer"||g=="float"){this.lastHoveredColumn=c;
var l=this.selectedRows.count()>0;var h=0;var b=this.selectedRows.getIterator();while(!b.atEnd()&&l){var i=b.get();var d=i.value.offset;if(this.buffer.isInRange(d)){var a=this.buffer.getRow(d);if(returnFormattedToCalc){h+=parseFloat(returnFormattedToCalc(a.getValue(f)));}else{h+=parseFloat(a.getValue(f));
}}else{l=false;}}if(!l){this.requestColumnTotals(c.name);}else{this.lastAddition=h;this.drawTotalNumber(this.lastAddition,e);}}else{this.drawTotalNumber("",e);}}else{var g=this.lastHoveredColumn.type.name;if(g=="integer"||g=="float"){this.drawTotalNumber(this.lastAddition,e);}}}},drawTotalNumber:function(a,b){window.status=a;
if(b){b.setAttribute("title",a);}},requestColumnTotals:function(b){var c=this.getSelectedRows();if(c==""){c="";}setCalloutProcessing(true);var a=dojo.hitch(this,"showColumnTotals");var e=[];e["action"]="getColumnTotals";e["columnName"]=b;e["rows"]=c;var d={url:this.dataUrl,handler:a,method:"POST",handleAs:"xml"};
openbravo.widget.DataGrid.io.asyncCall(d,e);},plainCellHeader:function(a){if(dojo.hasClass(a.target,"DataGrid_Header_Cell_hover")){dojo.removeClass(a.target,"DataGrid_Header_Cell_hover",false);}window.status="";},showColumnTotals:function(b,a){this.lastAddition=openbravo.widget.DataGrid.html.getContentAsString(b.getElementsByTagName("total")[0]);
window.status=parseFloat(this.lastAddition);},setBounds:function(){var a=openbravo.widget.DataGrid.html.extractPx(this.maxWidth);if(a>0&&a<=this.domNode.offsetWidth){this.tableNode.parentNode.style.width=this.maxWidth;this.domNode.style.width=a+2*this.scrollWidth+8+"px";}},cleanup:function(){var d=this.tableNode;
for(var c=0;c<d.rows.length;c++){for(var b=0;b<d.rows[c].cells.length;b++){var a=d.rows[c].cells[b];a.onmouseover=null;a.onmouseout=null;}}},setMaxWidth:function(){if(this.percentageWidthRelativeToId!="body"){var a=Math.round(this.proportion*document.getElementById(this.percentageWidthRelativeToId).clientWidth);
}else{var a=Math.round(this.proportion*dijit.getViewport().width);}a-=2*this.scrollWidth;this.maxWidth=a+"px";return a;},onResize:function(){this.setMaxWidth();if(this.numRows!=calculateNumRows()){this.numberOfResizes+=1;this.offsetBeforeResize=this.getCurrentOffset();this.hasBeenResized=true;this.numRows=calculateNumRows();
this.visibleRows=this.numRows;this.visibleRowsMax=this.numRows;document.getElementById(this.widgetId+"_container").innerHTML="";document.getElementById(this.widgetId+"_container").style.display="none";document.getElementById(this.widgetId+"_container").setAttribute("id",this.widgetId+"_container_old"+this.numberOfResizes);
this.render();}if(this.percentageWidthRelativeToId!="body"){var a=Math.round(this.proportion*document.getElementById(this.percentageWidthRelativeToId).clientWidth);}else{var a=Math.round(this.proportion*dijit.getViewport().width);}this.tableNode.parentNode.style.width=a-2*this.scrollWidth+"px";this.domNode.style.width=a-2*this.scrollWidth+40+"px";
},render:function(){var A=function(i){if(dojo&&!dojo.hasClass(this,"DataGrid_Body_Cell_hover")&&!dojo.hasClass(this,"DataGrid_Body_Cell_clicked")){dojo.addClass(this,"DataGrid_Body_Cell_hover");}};var d=function(i){if(dojo&&dojo.hasClass(this,"DataGrid_Body_Cell_hover")){dojo.removeClass(this,"DataGrid_Body_Cell_hover",false);
}};var t=this.widgetId;var e=document.createElement("table");if(isGridFocused){e.className="DataGrid_Header_Table_focus";}else{e.className="DataGrid_Header_Table";}if(this.sortable){e.id=t+"_table_header";}e.cellspacing=0;e.cellpadding=0;var y=document.createElement("tbody");var h=this.columns.count();
var k=document.createElement("tr");var f=0;for(var v=0;v<h;v++){var c=document.createElement("th");var m=this.columns.get(v);c.className=openbravo.widget.DataGrid.Column.prototype.DEFAULT_HEADER_CLASS;dojo.addClass(c,m.headerClassName);dojo.connect(c,"onmouseover",this,"hoverCellHeader");dojo.connect(c,"onmouseout",this,"plainCellHeader");
dojo.connect(c,"onmousedown",this,"resizeHeader");var r=m.title;c.innerHTML=(r&&typeof r=="string")?r.split(" ").join("&nbsp;"):r;if(m.visible){c.style.width=m.width;var g=m.width.indexOf("px");var x=m.width.substring(0,g);f+=parseInt(x);}else{c.style.display="none";}k.appendChild(c);}y.appendChild(k);
e.style.width=f+"px";e.appendChild(y);var z=document.createElement("table");z.id=t+"_table";z.cellspacing="0";z.cellpadding="0";if(isGridFocused){z.className="DataGrid_Body_Table_focus";}else{z.className="DataGrid_Body_Table";}z.style.width=f+"px";var a=document.createElement("tbody");for(var w=0;w<this.numRows;
w++){var k=document.createElement("tr");k.className="DataGrid_Body_Row";dojo.addClass(k,(w%2==0?"DataGrid_Body_Row_Even":"DataGrid_Body_Row_Odd"));dojo.connect(k,"onclick",this,"cellClicked");dojo.connect(k,"ondblclick",this,"cellDoubleClicked");for(var v=0;v<h;v++){var c=document.createElement("td");
var m=this.columns.get(v);c.className=openbravo.widget.DataGrid.Column.prototype.DEFAULT_CLASS;dojo.addClass(c,m.className);c.onmouseover=A;c.onmouseout=d;openbravo.widget.DataGrid.html.disableSelection(c);var l=document.createTextNode("");c.appendChild(l);if(m.visible){c.style.width=m.width;}else{c.style.display="none";
}k.appendChild(c);}a.appendChild(k);}z.appendChild(a);z.focus();this.tableNode=z;this.tableHeader=e;if(dojo.isIE&&!this.hasBeenResized){dojo.connect(this.domNode,"onkey",this,"keyPressed");}else{if(!this.hasBeenResized){dojo.connect(document,"onkey",this,"keyPressed");}}var n=this.domNode;var q=document.createElement("div");
q.id=t+"_container";q.innerHTML="<div style='float:left'></div>";var b=q.firstChild;b.id=t+"_viewPort";b.style.overflow="hidden";b.appendChild(e);b.appendChild(z);n.appendChild(q);this.setBounds();z.style.height=(k.offsetHeight+1)*(this.numRows);this.domNode.style.height=z.offsetHeight+"px";if(!this.hasBeenResized){var u=new Array();
if(this.sortCols!=null&&this.sortCols!=""){var B=this.sortCols.split(",");var p=B.length;for(var w=0;w<p;w++){u[w]=this.columns.get(B[w]).name;}}var o={prefetchBuffer:true,offset:this.offset,columns:this.columns,sortCols:u,sortDirs:((this.sortDirs!=null&&this.sortDirs!="")?this.sortDirs.split(","):[]),defaultRow:this.defaultRow,onscroll:this.onScroll};
}else{var o={prefetchBuffer:true,offset:this.offset,columns:this.columns,defaultRow:this.defaultRow,onscroll:this.onScroll};}this.postRendering(o);if(this.proportion){dojo.connect(window,"onresize",this,"onResize");}dojo.connect(this.scroller,"handleScroll",this,"handleScroll");dojo.addOnUnload(this,"cleanup");
setCalloutProcessing(false);},captureEvent:function(a,b){dojo.connect(this.tableNode,a,b);},getSelectedRows:function(){var a=[];this.selectedRows.forEach(function(b){a.push(b.value.id);});return a;},getSelectedRowsPos:function(){var a=[];this.selectedRows.forEach(function(b){a.push(b.value.offset);});
return a;},checkEditingRow:function(){return this.editingRow?this.saveRow():true;},goToPreviousRow:function(){if(this.checkEditingRow()){this.moveFromLastSelected(-1);}},goToNextRow:function(){if(this.checkEditingRow()){this.moveFromLastSelected(1);}},goToFirstRow:function(){if(this.checkEditingRow()){this.goToRow(0);
}},goToLastRow:function(){if(this.checkEditingRow()){this.goToRow(this.metaData.totalRows-1);}},goToPreviousPage:function(){if(!this.editing){this.moveCurrentPosition(-this.numRows);}},goToNextPage:function(){if(!this.editing){this.moveCurrentPosition(this.numRows);}},setFocus:function(){this.tableNode.focus();
if(this.selectedRows.count()==0){this.goToFirstRow();}else{this.goToRow(this.selectedRows.getLastSelected().offset);}this.showSelection();},setSortedColumns:function(b,a){this.sort.setColumnSort(b,((a=="DESC")?openbravo.widget.DataGrid.Column.SORT_DESC:openbravo.widget.DataGrid.Column.SORT_ASC));this.sortHandler(this.sortColumns);
},addNewRow:function(){if(!this.checkEditingRow()){return;}if(this.editingRow&&this.editingRow.isNewRow){return;}var a=dojo.hitch(this,function(){this.options.onRefreshComplete.remove(a);var d=this.getCurrentOffset();var e=this.numRows-1+d;var f=e-this.buffer.startPos;this.editingRow=this.createRowObject(this.metaData.totalRows-1);
var b=[];for(var c=0;c<this.metaData.columnCount;c++){b[c]="";}this.editingRow.setValues(b);this.editingRow.isNewRow=true;this.editingRow.rowNode=this.tableNode.rows[this.visibleRows-1];this.editingRow.setValue(0,this.metaData.totalRows);this.editingRow.getDefaultValues(this.dataUrl);this.buffer.rows[f]=this.editingRow;
this.selectRow(this.metaData.totalRows-1);});this.options.onRefreshComplete.push(a);this.metaData.totalRows++;this.setTotalRows(this.metaData.totalRows);this.goToRow(this.metaData.totalRows-1);},deleteRow:function(){if(this.selectedRows.count()>0&&this.selectedRows.getLastSelected()!=null&&showJSMessage(2)){if(this.editing){this.cancelEdit();
}this.editingRow=null;var b=[];b["action"]="deleteRow";var c=[];this.selectedRows.forEach(dojo.hitch(this,function(e){if(e.value.id){c.push(e.value.id);}}));if(c.length>0){b["rows"]=c;var a=dojo.hitch(this,"refreshGridDataAfterDelete");var d={url:this.updatesUrl,handler:a,method:"POST",handleAs:"xml"};
openbravo.widget.DataGrid.io.asyncCall(d,b);}else{this.refreshGridData();}}},refreshGridDataAfterDelete:function(e,k){var j=e.getElementsByTagName("xml-delete");var d=j[0].getElementsByTagName("status");if(d.length>0){var f=d[0].getElementsByTagName("type");var h=d[0].getElementsByTagName("title");var i=d[0].getElementsByTagName("description");
if(dojox.data.dom.textContent(f[0]).toUpperCase()!="HIDDEN"){try{initialize_MessageBox("messageBoxID");}catch(b){}try{setValues_MessageBox("messageBoxID",dojox.data.dom.textContent(f[0]),dojox.data.dom.textContent(h[0]),dojox.data.dom.textContent(i[0]));}catch(c){alert(dojox.data.dom.textContent(h[0])+":\n"+dojox.data.dom.textContent(i[0]));
}}}var a=j[0].getElementsByTagName("info");var l=a[0].getElementsByTagName("result");var g=a[0].getElementsByTagName("total");if(dojox.data.dom.textContent(l[0])!=0){this.metaData.totalRows=this.metaData.totalRows-parseInt(dojox.data.dom.textContent(g[0]));this.selectedRows.clear();this.refreshGridData();
}this.onResize();},refreshGridDataAfterFilter:function(){this.buffer.isFilter=true;this.selectedRows.clear();this.isFirstLoad=true;selectedRow=0;this.setTotalRows(this.visibleRowsMax);this.moveTableContent(0);this.isIE=dojo.isIE;if(!this.isIE){this.goToFirstRow();}return true;},refreshGridData:function(){for(var b=0;
b<this.numRows;b++){if(isGridFocused){openbravo.widget.DataGrid.html.prereplaceClass(this.tableNode.rows[b],b%2==0?"DataGrid_Body_Row_Even":"DataGrid_Body_Row_Odd","DataGrid_Body_Row_focus");}else{openbravo.widget.DataGrid.html.prereplaceClass(this.tableNode.rows[b],b%2==0?"DataGrid_Body_Row_Even":"DataGrid_Body_Row_Odd","DataGrid_Body_Row_selected");
}}var a=this.getCurrentOffset();if(a>this.metaData.totalRows-this.numRows){a=this.metaData.totalRows-this.numRows;}if(a<0){a=0;}this.setTotalRows(this.metaData.totalRows);this.moveTableContent(a);},focusGrid:function(){isGridFocused=true;openbravo.widget.DataGrid.html.prereplaceClass(this.table,"DataGrid_Body_Table_focus","DataGrid_Body_Table");
openbravo.widget.DataGrid.html.prereplaceClass(this.tableHeader,"DataGrid_Header_Table_focus","DataGrid_Header_Table");for(var a=0;a<this.numRows;a++){if(this.tableNode.rows[a].className.indexOf("DataGrid_Body_Row_selected")!=-1){openbravo.widget.DataGrid.html.prereplaceClass(this.tableNode.rows[a],"DataGrid_Body_Row_focus","DataGrid_Body_Row_selected");
}}return true;},blurGrid:function(){isGridFocused=false;openbravo.widget.DataGrid.html.prereplaceClass(this.table,"DataGrid_Body_Table","DataGrid_Body_Table_focus");openbravo.widget.DataGrid.html.prereplaceClass(this.tableHeader,"DataGrid_Header_Table","DataGrid_Header_Table_focus");for(var a=0;a<this.numRows;
a++){if(this.tableNode.rows[a].className.indexOf("DataGrid_Body_Row_focus")!=-1){openbravo.widget.DataGrid.html.prereplaceClass(this.tableNode.rows[a],"DataGrid_Body_Row_selected","DataGrid_Body_Row_focus");}}return true;},setCellContent:function(d,b,c){var e=null;if(this.buffer.isInRange(d)){e=this.buffer.getRow(d);
}if(e!=null){var a=this.columns.get(b);if(!isNaN(c)){c=parseFloat(c);}e.setValue(a.index,c);e.sendRow();}},moveFromLastSelected:function(c){if(this.selectedRows.count()>0){var a=this.selectedRows.getLastSelected().offset;var b=a+c;if(b>=0&&b<this.metaData.totalRows){this.goToRow(b);}}},selectRow:function(c,b){var d=this.buffer.getRow(c);
if(!d){d=this.createRowObject(null);}var e=d.getValue(this.columns.getIdentifier().name);if(escape(e)!="%A0"){if(b){this.options.onRefreshComplete.remove(b);}var a={id:e,offset:c};this.selectedRows.clear();this.selectedRows.add(a);this.showSelection();}},getCurrentOffset:function(){return parseInt(this.scroller.scrollerDiv.scrollTop/this.viewPort.rowHeight);
},setRequestParams:function(a){this.requestParams=a;},moveTableContent:function(a){this.fetchBuffer(a);this.scroller.moveScroll(a);this.viewPort.scrollTo(this.scroller.rowToPixel(a));},moveCurrentPosition:function(b){var a=this.getCurrentOffset()+b;if(a<0){a=0;}else{if(a>=(this.metaData.totalRows-1)){a=this.metaData.totalRows-this.numRows;
}}this.moveTableContent(a);this.selectRow(a);this.showSelection();},getSelectRowFunction:function(b){var c=this;var a=dojo.hitch(this,"selectRow",b,a);return a;},goToRow:function(d){var e=this;var b=dojo.hitch(this,"selectRow",d,b);if(d>=0){var c=this.getCurrentOffset();var a=c+this.numRows;if(c<=d&&d<a){if(this.metaData.totalRows<=this.numRows){this.moveTableContent(0);
}this.selectRow(d);}else{if(b!=null){this.options.onRefreshComplete.push(b);}if(d==(c-1)){this.moveTableContent(c-1);}else{if(d==a){this.moveTableContent(c+1);}else{if(d>=(this.metaData.totalRows-1)){this.moveTableContent(d-this.visibleRows+1);}else{if(d>=(this.metaData.totalRows-this.visibleRows)){this.moveTableContent(this.metaData.totalRows-this.visibleRows);
}else{this.moveTableContent(d);}}}}}checkAttachmentIconRelation();}},resizeColumn:function(c,b,e){if(b){var d=b.index;e=(e>9?e:9);var a=openbravo.widget.DataGrid.html.extractPx(this.tableNode.style.width);var f=a+(e-openbravo.widget.DataGrid.html.extractPx(b.width));if(a!=f){this.hasResized=true;}e+="px";
this.columns.get(d).width=e;c.cells[d].style.width=e;this.tableNode.style.width=f+"px";this.tableHeader.style.width=f+"px";dojo.forEach(this.tableNode.rows,function(g){g.cells[d].style.width=e;});}},doResize:function(a){var c=this.resizingParams;if(parent.isRTL){var b=c.width-a.clientX+c.start;}else{var b=c.width+a.clientX-c.start;
}c.self.resizeColumn(c.target.parentNode,c.column,b);this.setBounds();},endResize:function(b){var a=dojo.body();var d=this.resizingParams;if(parent.isRTL){var c=d.width-b.clientX+d.start;}else{var c=d.width+b.clientX-d.start;}dojo.disconnect(this.startResizeConnection);dojo.disconnect(this.endResizeConnection);
d.self.resizeColumn(d.target.parentNode,d.column,c);},resizeHeader:function(b){var e=openbravo.widget.DataGrid.html.getParentByType(b.target,"th");var a=dojo.body();var d=dojo.indexOf(e.parentNode.cells,e);var c=this.columns.get(d);if(!c){return;}this.resizingParams={start:b.clientX,self:this,target:e,width:openbravo.widget.DataGrid.html.extractPx(c.width),scroll:e.parentNode.parentNode.scrollLeft,column:c};
this.hasResized=false;this.startResizeConnection=dojo.connect(a,"onmousemove",this,"doResize");this.endResizeConnection=dojo.connect(a,"onmouseup",this,"endResize");dojo.stopEvent(b);},postRendering:function(b){this.options={tableClass:this.tableNode.className,loadingClass:this.tableNode.className,scrollerBorderRight:"1px solid #ababab",bufferTimeout:15000,blankImg:dojo.baseUrl+"../../openbravo/templates/blank.gif",sortAscendImg:dojo.baseUrl+"../../openbravo/templates/sort_asc.gif",sortDescendImg:dojo.baseUrl+"../../openbravo/templates/sort_desc.gif",rowEditingImg:dojo.baseUrl+"../../openbravo/templates/editingRow.png",rowErrorImg:dojo.baseUrl+"../../openbravo/templates/rowError.png",rowRefreshingImg:dojo.baseUrl+"../../openbravo/templates/refreshingRow.png",rowSavedImg:dojo.baseUrl+"../../openbravo/templates/rowSaved.png",iconImages:[],largeBufferSize:this.bufferSize,sortImageWidth:9,sortImageHeight:5,ajaxSortURLParms:[],onRefreshComplete:[],requestParameters:null,inlineStyles:true,hasResized:dojo.hitch(this,function(){return this.hasResized;
}),failedRows:new dojox.collections.Dictionary()};dojo.mixin(this.options,b);new Image().src=this.options.rowEditingImg;new Image().src=this.options.rowErrorImg;new Image().src=this.options.rowRefreshingImg;new Image().src=this.options.rowSavedImg;this.options.iconImages[openbravo.widget.DataGrid.Row.prototype.ERROR]=this.options.rowErrorImg;
this.options.iconImages[openbravo.widget.DataGrid.Row.prototype.SAVED]=this.options.rowSavedImg;this.options.iconImages[openbravo.widget.DataGrid.Row.prototype.EDITING]=this.options.rowEditingImg;this.options.iconImages[openbravo.widget.DataGrid.Row.prototype.REFRESHING]=this.options.rowRefreshingImg;
var e=this;this.options.onRefreshComplete.remove=function(f){var g=dojo.indexOf(e.options.onRefreshComplete,f);e.options.onRefreshComplete.splice(g,1);};this.ajaxOptions={parameters:null};this.tableId=this.tableNode.id;this.table=this.tableNode;this.hasResized=false;var c=this.table.rows[0].cells.length;
this.metaData=new openbravo.widget.DataGrid.MetaData(this.numRows,0,c,this.options);this.buffer=new openbravo.widget.DataGrid.Buffer(this.metaData,this);var a=this.table.rows.length;this.viewPort=new openbravo.widget.DataGrid.ViewPort(this.tableNode,this.tableNode.offsetHeight/a,this.numRows,this.buffer,this);
this.scroller=new openbravo.widget.DataGrid.Scroller(this,this.viewPort);this.options.sortHandler=dojo.hitch(this,"sortHandler");if(dojo.byId(this.tableId+"_header")){this.sort=new openbravo.widget.DataGrid.SortingHandler(this.tableId+"_header",this.options);}this.processingRequest=null;this.unprocessedRequest=null;
if(this.options.prefetchBuffer||this.options.prefetchOffset>0){var d=0;if(this.options.offset){d=this.options.offset;this.scroller.moveScroll(d);this.viewPort.scrollTo(this.scroller.rowToPixel(d));}if(this.options.sortCols){this.sortCols=b.sortCols;this.sortDirs=b.sortDirs;}this.requestContentRefresh(d);
}},resetContents:function(){this.scroller.moveScroll(0);this.buffer.clear();this.viewPort.clearContents();},sortHandler:function(a){if(!a){return;}this.sortCols=[];this.sortDirs=[];dojo.forEach(a,dojo.hitch(this,function(b){this.sortCols.push(b.name);this.sortDirs.push(b.currentSort);}));this.sortCols.reverse();
this.sortDirs.reverse();gridMovePage("FIRSTPAGE");},setTotalRows:function(c){if(c<=this.numRows){this.visibleRows=c;if(dojo.isIE){for(var a=0;a<c;a++){this.tableNode.rows[a].style.display="block";}for(var a=c;a<this.numRows;a++){this.tableNode.rows[a].style.display="none";}}else{if(c>0){var b=this.tableNode.rows[0].clientHeight;
}for(var a=0;a<c;a++){this.tableNode.rows[a].style.height=b+"px";openbravo.widget.DataGrid.html.setVisibility(this.tableNode.rows[a],true);}for(var a=c;a<this.numRows;a++){openbravo.widget.DataGrid.html.setVisibility(this.tableNode.rows[a],false);}}this.tableNode.style.height=this.viewPort.rowHeight*this.visibleRows+"px";
this.scroller.updateHeight();}this.resetContents();this.metaData.setTotalRows(c);this.scroller.updateHeight();this.scroller.updateSize();},handleTimedOut:function(){this.processingRequest=null;this.processQueuedRequest();showJSMessage(24);setCalloutProcessing(false);},fetchBuffer:function(g){if(this.buffer.isInRange(g)&&!this.buffer.isNearingLimit(g)){return;
}if(this.processingRequest){this.unprocessedRequest=new openbravo.widget.DataGrid.ContentRequest(g);return;}setCalloutProcessing(true);var c=this.buffer.getFetchOffset(g);this.processingRequest=new openbravo.widget.DataGrid.ContentRequest(g);this.processingRequest.bufferOffset=c;var a=this.buffer.getFetchSize(g);
var h=false;var d=[];if(this.requestParams){for(var f in this.requestParams){d[f]=this.requestParams[f];}}d["action"]="getRows";d["page_size"]=a;d["offset"]=c;if(this.sortCols){d["sort_cols"]=this.sortCols.reverse();d["sort_dirs"]=this.sortDirs.reverse();}var b=dojo.hitch(this,"ajaxUpdate");var e={url:this.dataUrl,handler:b,method:"POST",handleAs:"xml"};
openbravo.widget.DataGrid.io.asyncCall(e,d);if(this.timeoutHandler==null){this.timeoutHandler=new Array();}this.timeoutHandler[this.timeoutHandler.length]=setTimeout(dojo.hitch(this,"handleTimedOut"),this.options.bufferTimeout);},requestContentRefresh:function(a){this.fetchBuffer(a);},ajaxUpdate:function(c,a){try{if(this.timeoutHandler!=null&&this.timeoutHandler.length>0){clearTimeout(this.timeoutHandler.shift());
}this.buffer.update(c,this.processingRequest.bufferOffset);this.viewPort.bufferChanged();}catch(b){}finally{this.processingRequest=null;}if(this.isFirstLoad){this.isFirstLoad=false;this.onGridLoad();}if(this.hasBeenResized){this.hasBeenResized=false;this.moveTableContent(this.offsetBeforeResize);}this.processQueuedRequest();
setCalloutProcessing(false);},processQueuedRequest:function(){if(this.unprocessedRequest!=null&&this.unprocessedRequest.requestOffset>0){this.requestContentRefresh(this.unprocessedRequest.requestOffset);this.unprocessedRequest=null;}},setGridPaging:function(a,b){if(a){document.getElementById("prevRange_table").style.display="";
document.getElementById("fillGapRange_table").style.display="none";}else{document.getElementById("prevRange_table").style.display="none";document.getElementById("fillGapRange_table").style.display="";}if(b){document.getElementById("nextRange_table").style.display="";}else{document.getElementById("nextRange_table").style.display="none";
}},gridMovePage:function(a){this.requestParams["movePage"]=a;this.refreshGridDataAfterFilter();this.requestParams["movePage"]="";}});function createTextCellElement(e){var d=function(f){if(dojo&&!dojo.hasClass(this,"DataGrid_Body_Cell_hover")&&!dojo.hasClass(this,"DataGrid_Body_Cell_clicked")){dojo.addClass(this,"DataGrid_Body_Cell_hover");
}};var b=function(f){if(dojo&&dojo.hasClass(this,"DataGrid_Body_Cell_hover")){dojo.removeClass(this,"DataGrid_Body_Cell_hover",false);}};var c=document.createElement("nobr");c.className=openbravo.widget.DataGrid.Column.prototype.DEFAULT_CLASS;dojo.addClass(c,e.className);c.onmouseover=d;c.onmouseout=b;
openbravo.widget.DataGrid.html.disableSelection(c);var a=document.createTextNode("");c.appendChild(a);if(e.visible){c.style.width=e.width;}else{c.style.display="none";}return c;}dojo.declare("openbravo.widget.DataGrid.Parser",null,{constructor:function(a){this.datagrid=a;},ajaxUpdate:function(b,a){this.parseStructure(b);
},parseStructure:function(q){try{var d=q.getElementsByTagName("xml-structure");var e=d[0].getElementsByTagName("datagrid");var v=d[0].getElementsByTagName("status");if(v.length>0){var P=v[0].getElementsByTagName("type");var y=v[0].getElementsByTagName("title");var m=v[0].getElementsByTagName("description");
if(dojox.data.dom.textContent(P[0]).toUpperCase()!="HIDDEN"){try{renderMessageBox(dojox.data.dom.textContent(P[0]),dojox.data.dom.textContent(y[0]),dojox.data.dom.textContent(m[0]));}catch(M){alert(dojox.data.dom.textContent(y[0])+":\n"+dojox.data.dom.textContent(m[0]));}}}var N=e[0].getAttribute("backendPageSize");
var n=parseInt(N);this.datagrid.backendPageSize=n;var O=e[0].getElementsByTagName("validator");for(var L=0;L<O.length;L++){openbravo.loadScriptFromUrl(O[L].getAttribute("src"));this.datagrid.validators.push(O[L].getAttribute("className"));}var s=e[0].getElementsByTagName("types");var I=new openbravo.widget.DataGrid.TypeFactory();
if(s.length>0){var F=s[0].getElementsByTagName("type");for(var L=0;L<F.length;L++){var l=F[L].getAttribute("name");var H=F[L].getAttribute("kind");if(H=="enum"){var A=F[L].getElementsByTagName("enumeration");var P=new openbravo.widget.DataGrid.EnumType(l);for(var K=0;K<A.length;K++){var D=A[K].getAttribute("value");
P.addValue(D);}I.addType(P);}else{if(H=="class"){var P=new openbravo.widget.DataGrid.CustomType(l);P.className=F[L].getAttribute("className");openbravo.loadScriptFromUrl(F[L].getAttribute("src"));I.addType(P);}else{throw Error("Unknown kind for type named "+l);}}}}var l=this.datagrid.lineNoColumnTitle;
var z="string";var P=I.getType(z);var o;if(this.datagrid.maxWidth=="0px"){o=dijit.getViewport().width-80-openbravo.widget.DataGrid.html.extractPx(this.datagrid.lineNoColumnWidth);}else{o=openbravo.widget.DataGrid.html.extractPx(this.datagrid.maxWidth)-3*this.datagrid.scrollWidth-openbravo.widget.DataGrid.html.extractPx(this.datagrid.lineNoColumnWidth);
}var a={width:this.datagrid.lineNoColumnWidth,readonly:"true",required:"false",sortable:"false",className:this.datagrid.lineNoColumnClass,headerClassName:this.datagrid.lineNoColumnHeaderClass,visible:this.datagrid.showLineNumbers};var E=new openbravo.widget.DataGrid.Column(l,P,a);this.datagrid.columns.addColumn(E);
var B=e[0].getElementsByTagName("columns");var h=B[0].getElementsByTagName("column");for(var L=0;L<h.length;L++){if(h[L].parentNode==B[0]){var l=h[L].getAttribute("name");var z=h[L].getAttribute("type");var P=I.getType(z);var g=h[L].getElementsByTagName("invalidates");var G=[];if(g.length>0){var p=g[0].getElementsByTagName("column");
for(var K=0;K<p.length;K++){G.push(p[K].getAttribute("name"));}}var r=h[L].getAttribute("width");if(r){var w=r.indexOf("%");if(w>0){r=r.substr(0,w)*o/100+"px";}}var a={title:h[L].getAttribute("title"),width:r,readonly:h[L].getAttribute("readonly"),required:h[L].getAttribute("required"),sync:h[L].getAttribute("sync"),visible:h[L].getAttribute("visible"),sortable:h[L].getAttribute("sortable"),className:h[L].getAttribute("className"),headerClassName:h[L].getAttribute("headerClassName"),identifier:h[L].getAttribute("identifier"),invalidates:G,subordinated:[]};
var E=new openbravo.widget.DataGrid.Column(l,P,a);this.datagrid.columns.addColumn(E);}}if(!this.datagrid.columns.getIdentifier()){throw Error("No identifier specified");}var f=this.datagrid.columns.count();for(var L=0;L<f;L++){var b=this.datagrid.columns.get(L);var c=[];for(var K=0;K<f;K++){var t=this.datagrid.columns.get(K);
var x=t.invalidates;var u=x.length;for(var J=0;J<u;J++){if(x[J]==b.name){c[c.length]=t.name;}}}b.subordinated=c;}this.datagrid.render();}catch(C){this.xmlError(C);}},xmlError:function(a){alert("Error while parsing datagrid structure:\n\n"+a.message);}});dojo.declare("openbravo.widget.DataGrid.Type",null,{constructor:function(a){this.name=a;
},renderEditor:function(b){var a=document.createElement("input");a.setAttribute("autocomplete","off");a.value=b.initialValue;b.parentNode.appendChild(a);a.style.width=b.width-8+"px";return new openbravo.widget.DataGrid.InputEditorHandler(a);},validate:function(a){return true;}});dojo.declare("openbravo.widget.DataGrid.StringType",openbravo.widget.DataGrid.Type,{});
dojo.declare("openbravo.widget.DataGrid.IntegerType",openbravo.widget.DataGrid.Type,{constructor:function(a){dojo.require("dojox.validate");},renderEditor:function(e){var b="IntegerTextbox";var a=document.createElement("input");e.parentNode.appendChild(a);var c={name:e.name,value:e.initialValue,trim:"true",required:e.required,invalidMessage:" ",missingMessage:"*"};
var d=dojo.widget.createWidget(b,c,a);d.textbox.style.width=e.width-8+"px";d.textbox.setAttribute("autocomplete","off");return new openbravo.widget.DataGrid.InputEditorHandler(d.textbox);},validate:function(a){return dojox.validate.isNumberFormat(a);}});dojo.declare("openbravo.widget.DataGrid.FloatType",openbravo.widget.DataGrid.Type,{constructor:function(a){dojo.require("dojox.validate");
},renderEditor:function(e){var b="RealNumberTextbox";var a=document.createElement("input");e.parentNode.appendChild(a);var c={name:e.name,value:e.initialValue,trim:"true",required:e.required,invalidMessage:" ",missingMessage:"*"};var d=dojo.widget.createWidget(b,c,a);d.textbox.style.width=e.width-8+"px";
d.textbox.setAttribute("autocomplete","off");return new openbravo.widget.DataGrid.InputEditorHandler(d.textbox);},validate:function(a){return dojox.validate.isNumberFormat(a);}});dojo.declare("openbravo.widget.DataGrid.DateType",openbravo.widget.DataGrid.Type,{constructor:function(a){dojo.require("dijit.form.DateTextBox");
},renderEditor:function(e){var b="DropdownDatePicker";var a=document.createElement("input");e.parentNode.appendChild(a);var c={};var d=dojo.widget.createWidget(b,c,a);d.inputNode.value=e.initialValue;d.inputNode.style.width=e.width-30+"px";d.inputNode.setAttribute("autocomplete","off");return new openbravo.widget.DataGrid.InputEditorHandler(d.inputNode);
},validate:function(a){return dojox.validate.isNumberFormat(a);}});dojo.declare("openbravo.widget.DataGrid.UrlType",openbravo.widget.DataGrid.Type,{});dojo.declare("openbravo.widget.DataGrid.ImgType",openbravo.widget.DataGrid.Type,{});dojo.declare("openbravo.widget.DataGrid.EnumType",openbravo.widget.DataGrid.Type,{constructor:function(a){this.values=[];
},addValue:function(a){this.values.push(a);},renderEditor:function(h){var a=document.createElement("select");for(var c=0;c<this.values.length;c++){var g=this.values[c];var e=new Option(g,g,false);a.options[a.options.length]=e;}a.value=h.initialValue;h.parentNode.appendChild(a);var b="ComboBox";var d={autoComplete:true,mode:"local"};
var f=dojo.widget.createWidget(b,d,a);f.textInputNode.style.width=h.width-30+"px";f.textInputNode.setAttribute("autocomplete","off");f.textInputNode.value=h.initialValue;return new openbravo.widget.DataGrid.InputEditorHandler(f.textInputNode);},validate:function(a){return a==""||openbravo.widget.DataGrid.html.inArray(this.values,a);
}});dojo.declare("openbravo.widget.DataGrid.DynamicEnumType",openbravo.widget.DataGrid.EnumType,{constructor:function(a){this.widget=null;},populateCombo:function(f,a){var b=f.getElementsByTagName("option");var e=[];for(var c=0;c<b.length;c++){var d=openbravo.widget.DataGrid.html.getContentAsString(b[c]);
e.push([d,d]);this.values.push(d);}this.widget.dataProvider.setData(e);},queryContent:function(c){var h=[];var g=[];var j=true;for(var d=0;d<c.subordinated.length&&j;d++){var a=c.subordinated[d];g.push(a);var f=c.row.getValue(a);if(f==""){j=false;}else{h[a]=f;}}if(j){var l=dojo.hitch(this,"populateCombo");
var e=[];e["action"]="getComboContent";e["subordinatedColumn"]=c.name;for(var d=0;d<c.subordinated.length;d++){e[a]=h[g[d]];}var b="";var k={url:c.cellSaver.dataUrl,handler:l,method:"POST",handleAs:"xml"};openbravo.widget.DataGrid.io.asyncCall(k,e);}},renderEditor:function(e){var a=document.createElement("select");
e.parentNode.appendChild(a);var b="combobox";var c={autoComplete:true,mode:"local"};var d=dojo.widget.createWidget(b,c,a);d.textInputNode.style.width=e.width-30+"px";d.textInputNode.setAttribute("autocomplete","off");d.textInputNode.value=e.initialValue;this.widget=d;this.queryContent(e);return new openbravo.widget.DataGrid.InputEditorHandler(d.textInputNode);
}});dojo.declare("openbravo.widget.DataGrid.CustomType",openbravo.widget.DataGrid.Type,{constructor:function(a){this.className="";},renderEditor:function(c){c.cell.innerHTML=c.initialValue;var a=dojo.getObject(this.className,true);var d=new openbravo.widget.DataGrid.EditorHandler(function(){return c.initialValue;
});var b={save:function(f){for(var e in f){c.row.setValue(e,f[e]);}c.row.updateGrid();d.getValue=function(){return f[c.name];};c.cellSaver.unlockGrid();c.cellSaver.save();},cancel:function(){c.cellSaver.unlockGrid();c.cellSaver.cancel();}};c.cellSaver.lockGrid();new a(c.row,b).render();return d;}});dojo.declare("openbravo.widget.DataGrid.TypeFactory",null,{constructor:function(){var b=[];
b["string"]="openbravo.widget.DataGrid.StringType";b["integer"]="openbravo.widget.DataGrid.IntegerType";b["float"]="openbravo.widget.DataGrid.FloatType";b["date"]="openbravo.widget.DataGrid.DateType";b["url"]="openbravo.widget.DataGrid.UrlType";b["img"]="openbravo.widget.DataGrid.ImgType";b["dynamicEnum"]="openbravo.widget.DataGrid.DynamicEnumType";
var a=[];this.addType=function(c){a[c.name]=c;};this.getType=function(c){if(a[c]){return a[c];}else{var e=b[c];var d;if(e){var f=dojo.getObject(e,true);d=new f(c);}else{d=new openbravo.widget.DataGrid.Type(c);}a[c]=d;return d;}};}});dojo.declare("openbravo.widget.DataGrid.EditorHandler",null,{constructor:function(){this.getValue=function(){};
this.setFocus=function(){};}});dojo.declare("openbravo.widget.DataGrid.InputEditorHandler",openbravo.widget.DataGrid.EditorHandler,{constructor:function(a){this.getValue=function(){return a.value;};this.setFocus=function(){if(a.parentNode){a.focus();}};}});dojo.declare("openbravo.widget.DataGrid.Columns",null,{constructor:function(){var b=[];
var a=null;this.count=function(){return b.length;};this.addColumn=function(c){c.index=b.length;b[b.length]=c;if(c.identifier){if(a){throw Error("Column "+c.name+" set as an identifier, but "+a.name+" is already the identifier.");}a=c;}};this.removeColumn=function(c){if(b[c].identifier){a=null;}b[c]=null;
};this.get=function(c){if(!isNaN(c)){return b[c];}else{for(var d in b){if(b[d].name==c){return b[d];}}}};this.getIdentifier=function(){return a;};}});dojo.declare("openbravo.widget.DataGrid.Column",null,{DEFAULT_WIDTH:"100px",DEFAULT_CLASS:"DataGrid_Body_Cell",DEFAULT_CLASS_INVERSE:"DataGrid_Body_Cell DataGrid_Body_Cell_Inverse",DEFAULT_HEADER_CLASS:"DataGrid_Header_Cell",DEFAULT_HEADER_CLASS_INVERSE:"DataGrid_Header_Cell DataGrid_Header_Cell_Inverse",constructor:function(a,b,c){this.index=-1;
this.name=a;this.type=b;this.title=c.title?c.title:a;this.width=c.width?c.width:this.DEFAULT_WIDTH;this.readonly=c.readonly=="true";this.required=c.required!="false";this.sync=c.sync=="true";this.visible=c.visible!="false";this.sortable=c.sortable!="false";if(this.type.name=="integer"||this.type.name=="float"){this.className=c.className?c.className:this.DEFAULT_CLASS_INVERSE;
this.headerClassName=c.headerClassName?c.headerClassName:this.DEFAULT_HEADER_CLASS_INVERSE;}else{this.className=c.className?c.className:this.DEFAULT_CLASS;this.headerClassName=c.headerClassName?c.headerClassName:this.DEFAULT_HEADER_CLASS;}this.identifier=c.identifier=="true";this.invalidates=c.invalidates?c.invalidates:[];
this.subordinated=[];this.currentSort=openbravo.widget.DataGrid.Column.UNSORTED;if(this.identifier||!this.visible||this.readonly){this.required=false;}if(this.identifier){this.readonly=true;}},renderEditor:function(h,i,c){var a=document.createElement("span");a.style.display="none";var g=dojo.indexOf(h.parentNode.cells,h);
var f=i.getValue(g);openbravo.widget.DataGrid.html.clearElement(h);var e=openbravo.widget.DataGrid.html.extractPx(h.style.width);var b={parentNode:a,initialValue:f,width:e,required:this.required,name:this.name,cell:h,subordinated:this.subordinated,cellSaver:c,row:i};var d=this.type.renderEditor(b);h.appendChild(a);
dojo.lfx.html.fadeShow(a,300,null,function(){d.setFocus();}).play();return d;},isSortable:function(){return this.sortable;},isSorted:function(){return this.currentSort!=openbravo.widget.DataGrid.Column.UNSORTED;},getSortDirection:function(){return this.currentSort;},toggleSort:function(){if(this.currentSort==openbravo.widget.DataGrid.Column.UNSORTED||this.currentSort==openbravo.widget.DataGrid.Column.SORT_DESC){this.currentSort=openbravo.widget.DataGrid.Column.SORT_ASC;
}else{if(this.currentSort==openbravo.widget.DataGrid.Column.SORT_ASC){this.currentSort=openbravo.widget.DataGrid.Column.SORT_DESC;}}},setUnsorted:function(a){this.setSorted(openbravo.widget.DataGrid.Column.UNSORTED);},setSorted:function(a){this.currentSort=a;}});openbravo.widget.DataGrid.Column.UNSORTED=0;
openbravo.widget.DataGrid.Column.SORT_ASC="ASC";openbravo.widget.DataGrid.Column.SORT_DESC="DESC";dojo.declare("openbravo.widget.DataGrid.Row",null,{CORRECT:0,ERROR:1,SAVED:2,EDITING:3,REFRESHING:4,constructor:function(b,a,i,d,c){this.modified=false;this.error=false;this.offset=b;this.rowNode=null;this.status=0;
this.isNewRow=false;var g=[];var e=openbravo.widget.DataGrid.html.toArray(g);var h=function(){var j={};for(var k=0;k<g.length;k++){j[a.get(k).name]=g[k];}return j;};this.updateGrid=function(){if(this.rowNode&&(!this.offset||c(this.offset))){for(var j=0;j<g.length;j++){var l=g[j];var m=l;if(l&&typeof l=="string"){m=l.split(" ").join("&nbsp;");
}var k=a.get(j);if(k.type.name=="url"&&m!=""){this.rowNode.cells[j].innerHTML='<a href="'+m+'" target=_blank><img src="../web/js/openbravo/templates/popup1.gif" border="0 title="Link" alt="Link"></a>&nbsp;'+m;}if(k.type.name=="img"&&m!=""){this.rowNode.cells[j].innerHTML="<a onclick=\"openPopUp('"+m+"', 'Image', '70%', '70%'); return false;\" href=\""+m+'"><img src="'+m+'" border="0" height="15px"></a>';
}else{this.rowNode.cells[j].innerHTML=m;}}if(this.status>0){this.setIcon();}}};this.getValue=function(j){if(isNaN(j)){j=a.get(j).index;}return g[j];};this.setValue=function(j,k){if(isNaN(j)){j=a.get(j).index;}if(g[j]!=k){g[j]=k;}this.modified=true;};this.setValues=function(k){for(var j=0;j<k.length;j++){g[j]=k[j];
}e=openbravo.widget.DataGrid.html.toArray(g);};this.checkFields=function(){var l=[];for(var j=0;j<g.length;j++){var k=a.get(j);if(k.required&&g[j]==""){l[l.length]=j;}}this.error=l.length>0;return l;};this.validate=function(j){var k=true;for(var m=0;m<j.length;m++){var l=dojo.getObject(j[m],true);k=new l().validate(h());
if(!k){break;}}this.error=!k;};this.handleError=function(j){this.setStatus(this.ERROR);var m=g[a.getIdentifier().index];i.failedRows.add(m);var l=openbravo.widget.DataGrid.html.getContentAsString(j.getElementsByTagName("title")[0]);var k=openbravo.widget.DataGrid.html.getContentAsString(j.getElementsByTagName("description")[0]);
g=openbravo.widget.DataGrid.html.toArray(e);this.updateGrid();d.handleError(l,k);};this.populateDefaultValues=function(j){dojo.forEach(j.childNodes,dojo.hitch(this,function(k){if(k.nodeType==dojox.data.dom.ELEMENT_NODE){var l=a.get(k.tagName);if(l){this.setValue(l.index,openbravo.widget.DataGrid.html.getContentAsString(k));
this.updateGrid();}}}));};this.getDefaultValues=function(j){var k=[];k["action"]="getDefaultValues";handlerRef=dojo.hitch(this,f);var l={url:j,handler:handlerRef,method:"POST",handleAs:"xml"};openbravo.widget.DataGrid.io.asyncCall(l,k);};var f=function(m,s){if(!m){return;}var n=m.getElementsByTagName("xml-data");
var l=n[0].getElementsByTagName("status");if(l.length>0){var o=l[0].getElementsByTagName("type");var p=l[0].getElementsByTagName("title");var r=l[0].getElementsByTagName("description");if(dojox.data.dom.textContent(o[0]).toUpperCase()!="HIDDEN"){try{renderMessageBox(dojox.data.dom.textContent(o[0]),dojox.data.dom.textContent(p[0]),dojox.data.dom.textContent(r[0]));
}catch(k){alert(dojox.data.dom.textContent(p[0])+":\n"+dojox.data.dom.textContent(r[0]));}}}var q=n[0].getElementsByTagName("error");if(q.length>0){this.handleError(q[0]);}else{var j=this.getValue(a.getIdentifier().index);if(j){this.setStatus(this.SAVED);}e=openbravo.widget.DataGrid.html.toArray(g);if(i.failedRows.contains(j)){i.failedRows.remove(j);
}setTimeout(dojo.hitch(this,function(){this.setStatus(this.CORRECT);}),2000);}var t=n[0].getElementsByTagName("rows");if(t.length>0){this.populateDefaultValues(t[0]);}};this.setStatus=function(j){this.status=j;if(this.rowNode){this.setIcon();}};this.setIcon=function(){this.removeIcon();if(this.status>0){if(i.iconImages[this.status]){var j=a.get(0);
var k=this.rowNode.cells[j.index].innerHTML;this.rowNode.cells[j.index].innerHTML=k+'&nbsp;&nbsp;<img width="16px" height="16px" '+'src="'+i.iconImages[this.status]+'"/>';}}};this.removeIcon=function(){if(this.rowNode.cells[0].innerHTML!=""){this.rowNode.cells[0].innerHTML=this.offset+1;}};this.sendRow=function(k){this.setStatus(this.REFRESHING);
var l=h();var j=dojo.hitch(this,f);if(this.isNewRow){l["action"]="addNewRow";}else{l["action"]="updateRow";}var m={url:k,handler:j,method:"POST",handleAs:"xml"};openbravo.widget.DataGrid.io.asyncCall(m,l);this.modified=false;if(this.isNewRow){this.isNewRow=false;}};}});dojo.declare("openbravo.widget.DataGrid.IndexedRows",null,{constructor:function(){var c=new dojox.collections.Dictionary();
var b;var a=[];this.count=function(){return c.count;};this.add=function(d){if(!c.contains(d.id)){c.add(d.id,d);a.push(d.id);}b=d;};this.clear=function(){c.clear();a=new Array();b=null;};this.remove=function(f){c.remove(f);if(b.id==f){a.pop();var f=a[a.length-1];b=c.item(f);}else{var e=a.length;for(var d=0;
d<e;d++){if(f==a[d]){a.splice(d,1);break;}}}};this.getLastSelected=function(){return b;};this.contains=this.containsKey=c.contains;this.get=c.item;this.getKeyList=c.getKeyList;this.forEach=c.forEach;this.getIterator=c.getIterator;}});dojo.declare("openbravo.widget.DataGrid.MetaData",null,{constructor:function(a,c,d,b){this.pageSize=a;
this.totalRows=c;this.setOptions(b);this.ArrowHeight=16;this.columnCount=d;this.backendPage=0;},setOptions:function(a){this.options={largeBufferSize:7,nearLimitFactor:0.2};dojo.mixin(this.options,a||{});},getPageSize:function(){return this.pageSize;},getTotalRows:function(){return this.totalRows;},setTotalRows:function(a){this.totalRows=a;
},getBackendPage:function(){return this.backendPage;},getLargeBufferSize:function(){return parseInt(this.options.largeBufferSize*this.pageSize);},getLimitTolerance:function(){return parseInt(this.getLargeBufferSize()*this.options.nearLimitFactor);}});dojo.declare("openbravo.widget.DataGrid.Scroller",null,{constructor:function(b,a){this.isIE=dojo.isIE;
this.liveGrid=b;this.metaData=b.metaData;this.createScrollBar();this.scrollTimeout=null;this.lastScrollPos=0;this.viewPort=a;this.rows=[];},isUnPlugged:function(){return this.scrollerDiv.onscroll==null;},plugin:function(){this.scrollerDiv.onscroll=dojo.hitch(this,"handleScroll");},unplug:function(){this.scrollerDiv.onscroll=null;
},sizeIEHeaderHack:function(){if(!this.isIE){return;}var a=dojo.byId(this.liveGrid.tableId+"_header");if(a){a.rows[0].cells[0].style.width=(a.rows[0].cells[0].offsetWidth+1)+"px";}},updateHeight:function(){var b=this.liveGrid.viewPort.visibleHeight();var e=this.liveGrid.table;var a=e.parentNode.firstChild.offsetHeight;
var d=this.scrollerDiv.style;d.top=a-16;d.height=b+"px";var c=parseInt(b*this.metaData.getTotalRows()/this.metaData.getPageSize());this.heightDiv.style.height=c+"px";if(c>b){d.borderRight=this.liveGrid.options.scrollerBorderRight;}else{d.borderRight="0px";}},createScrollBar:function(){var m=this.liveGrid.table;
this.fillGapRange=document.createElement("table");this.fillGapRange.className="DataGrid_Scroll_icon_prevRange";this.fillGapRange.id="fillGapRange_table";this.fillGapRange.style.cursor="default";this.fillGapRange.style.background="transparent";var e=document.createElement("tbody");var b=document.createElement("tr");
var i=document.createElement("td");b.appendChild(i);e.appendChild(b);this.fillGapRange.appendChild(e);this.prevRange=document.createElement("table");this.prevRange.className="DataGrid_Scroll_icon_prevRange";this.prevRange.id="prevRange_table";this.prevRange.onclick=function(){gridMovePage("PREVIOUSPAGE");
};this.prevRange.style.display="none";var d=document.createElement("tbody");var g=document.createElement("tr");var a=document.createElement("td");g.appendChild(a);d.appendChild(g);this.prevRange.appendChild(d);this.nextRange=document.createElement("table");this.nextRange.className="DataGrid_Scroll_icon_nextRange";
this.nextRange.id="nextRange_table";this.nextRange.onclick=function(){gridMovePage("NEXTPAGE");};this.nextRange.style.display="none";var k=document.createElement("tbody");var c=document.createElement("tr");var j=document.createElement("td");c.appendChild(j);k.appendChild(c);this.nextRange.appendChild(k);
this.scrolandRangeDiv=document.createElement("div");this.scrollerDiv=document.createElement("div");var f=this.scrollerDiv.style;f.position="relative";f.left=this.isIE?"-6px":"-3px";f.width="19px";f.overflow="auto";this.heightDiv=document.createElement("div");this.heightDiv.style.width="1px";this.updateHeight();
this.scrolandRangeDiv.appendChild(this.fillGapRange);this.scrolandRangeDiv.appendChild(this.prevRange);this.scrolandRangeDiv.appendChild(this.scrollerDiv);this.scrolandRangeDiv.appendChild(this.nextRange);this.scrollerDiv.appendChild(this.heightDiv);this.scrollerDiv.onscroll=dojo.hitch(this,"handleScroll");
m.parentNode.parentNode.insertBefore(this.scrolandRangeDiv,m.parentNode.nextSibling);m.parentNode.style.overflowX="auto";var h=this.isIE?"onmousewheel":"DOMMouseScroll";var l=dojo.hitch(this,function(n){var o=0;if(!n){n=window.event;}if(n.wheelDelta){o=n.wheelDelta/120;if(window.opera){o=-o;}}else{if(n.detail){o=-n.detail/3;
}}if(o){if(o>0){this.scrollerDiv.scrollTop-=(2*this.viewPort.rowHeight);}else{this.scrollerDiv.scrollTop+=(2*this.viewPort.rowHeight);}this.handleScroll(false);}if(n.preventDefault){n.preventDefault();}n.returnValue=false;});if(window.addEventListener){this.liveGrid.domNode.addEventListener("DOMMouseScroll",l,false);
}else{dojo.connect(this.liveGrid.domNode,h,l);}},updateSize:function(){var b=this.liveGrid.table;var a=this.viewPort.visibleHeight();this.heightDiv.style.height=parseInt(a*this.metaData.getTotalRows()/this.metaData.getPageSize())+"px";},rowToPixel:function(a){return(a/this.metaData.getTotalRows())*this.heightDiv.offsetHeight;
},moveScroll:function(a){this.scrollerDiv.scrollTop=this.rowToPixel(a);if(this.metaData.options.onscroll){this.metaData.options.onscroll(this.liveGrid,a);}},handleScroll:function(){if(this.metaData.totalRows!="0"){if(this.scrollTimeout){clearTimeout(this.scrollTimeout);}var c=this.lastScrollPos-this.scrollerDiv.scrollTop;
if(c!=0){var b=this.scrollerDiv.scrollTop%this.viewPort.rowHeight;if(b!=0){this.unplug();if(c<0){this.scrollerDiv.scrollTop+=(this.viewPort.rowHeight-b);}else{this.scrollerDiv.scrollTop-=b;}this.plugin();}}var a=parseInt(this.scrollerDiv.scrollTop/this.viewPort.rowHeight);this.liveGrid.requestContentRefresh(a);
this.viewPort.scrollTo(this.scrollerDiv.scrollTop);if(this.metaData.options.onscroll){this.metaData.options.onscroll(this.liveGrid,a);}this.scrollTimeout=setTimeout(dojo.hitch(this,"scrollIdle"),1200);this.lastScrollPos=this.scrollerDiv.scrollTop;}},scrollIdle:function(){if(this.metaData.options.onscrollidle){this.metaData.options.onscrollidle();
}}});dojo.declare("openbravo.widget.DataGrid.Buffer",null,{constructor:function(a,b){this.startPos=0;this.size=0;this.metaData=a;this.rows=[];this.updateInProgress=false;this.liveGrid=b;this.maxBufferSize=a.getLargeBufferSize()*2;this.maxFetchSize=a.getLargeBufferSize();this.lastOffset=0;this.isFilter=false;
},getBlankRow:function(){if(!this.blankRow){this.blankRow=this.liveGrid.createRowObject(null);var a=[];for(var b=0;b<this.metaData.columnCount;b++){a[b]="";}this.blankRow.setValues(a);}return this.blankRow;},loadRows:function(w){var h=w.getElementsByTagName("xml-data");var p=h[0].getElementsByTagName("status");
if(p.length>0){var f=p[0].getElementsByTagName("type");var v=p[0].getElementsByTagName("title");var r=p[0].getElementsByTagName("description");if(dojox.data.dom.textContent(f[0]).toUpperCase()!="HIDDEN"){try{renderMessageBox(dojox.data.dom.textContent(f[0]),dojox.data.dom.textContent(v[0]),dojox.data.dom.textContent(r[0]));
}catch(k){alert(dojox.data.dom.textContent(v[0])+":\n"+dojox.data.dom.textContent(r[0]));}}}var d=h[0].getElementsByTagName("rows")[0];this.updateUI=d.getAttribute("update_ui")=="true";var g=parseInt(d.getAttribute("numRows"));var o=d.getAttribute("backendPage");if(!o){o="0";}var t=parseInt(o);this.metaData.backendPage=t;
if(this.isFilter){this.metaData.totalRows=g;this.liveGrid.setTotalRows(g);this.isFilter=false;}if(this.metaData.totalRows==0){this.liveGrid.setTotalRows(g);this.liveGrid.fetchBuffer(0);if(this.metaData.options.onscroll){this.metaData.options.onscroll(this.liveGrid,0);}}var u=[];var n=d.getElementsByTagName("tr");
if(n.length>0){for(var s=0;s<n.length;s++){var l=u[s]=this.liveGrid.createRowObject(this.lastOffset+s);var e=n[s].getElementsByTagName("td");var c=[(t*this.liveGrid.getBackendPageSize())+this.lastOffset+s+1];for(var q=0;q<e.length;q++){var a=e[q];var b=dojox.data.dom.textContent(a);c.push(b);}l.setValues(c);
var m=l.getValue(this.liveGrid.columns.getIdentifier().index);if(this.liveGrid.options.failedRows.count>0){if(this.liveGrid.options.failedRows.contains(m)){l.setStatus(l.ERROR);}}}return u;}},update:function(b,d){var a=this.loadRows(b);if(a==null){a=[];}if(this.rows.length==0){this.rows=a;this.size=this.rows.length;
this.startPos=d;return;}if(d>this.startPos){if(this.startPos+this.rows.length<d){this.rows=a;this.startPos=d;}else{this.rows=this.rows.concat(a.slice(0,a.length));if(this.rows.length>this.maxBufferSize){var c=this.rows.length;this.rows=this.rows.slice(this.rows.length-this.maxBufferSize,this.rows.length);
this.startPos=this.startPos+(c-this.rows.length);}}}else{if(d+a.length<this.startPos){this.rows=a;}else{this.rows=a.slice(0,this.startPos).concat(this.rows);if(this.rows.length>this.maxBufferSize){this.rows=this.rows.slice(0,this.maxBufferSize);}}this.startPos=d;}this.size=this.rows.length;},clear:function(){this.rows=[];
this.startPos=0;this.size=0;},isOverlapping:function(b,a){return((b<this.endPos())&&(this.startPos<b+a))||(this.endPos()==0);},isInRange:function(a){return(a>=this.startPos)&&(a+this.metaData.getPageSize()<=this.endPos());},isNearingTopLimit:function(a){return a-this.startPos<this.metaData.getLimitTolerance();
},endPos:function(){return this.startPos+this.rows.length;},isNearingBottomLimit:function(a){return this.endPos()-(a+this.metaData.getPageSize())<this.metaData.getLimitTolerance();},isAtTop:function(){return this.startPos==0;},isAtBottom:function(){return this.endPos()==this.metaData.getTotalRows();},isNearingLimit:function(a){return(!this.isAtTop()&&this.isNearingTopLimit(a))||(!this.isAtBottom()&&this.isNearingBottomLimit(a));
},getFetchSize:function(c){var a=this.getFetchOffset(c);var b=0;if(a>=this.startPos){var d=this.maxFetchSize+a;if(this.metaData.totalRows>0&&d>this.metaData.totalRows){d=this.metaData.totalRows;}b=d-a;if(a==0&&b<this.maxFetchSize){b=this.maxFetchSize;}}else{var b=this.startPos-a;if(b>this.maxFetchSize){b=this.maxFetchSize;
}}return b;},getFetchOffset:function(b){var a=b;if(b>this.startPos){a=(b>this.endPos())?b:this.endPos();}else{if(b+this.maxFetchSize>=this.startPos){var a=this.startPos-this.maxFetchSize;if(a<0){a=0;}}}this.lastOffset=a;return a;},getRow:function(b){var a=this.getRows(b,1);if(a.length>0){return a[0];
}else{return this.liveGrid.editingRow;}},getRows:function(g,e){var f=g-this.startPos;var b=f+e;if(b>this.size){b=this.size;}var d=[];var a=0;for(var c=f;c<b;c++){d[a++]=this.rows[c];}return d;}});dojo.declare("openbravo.widget.DataGrid.ViewPort",null,{constructor:function(c,b,d,a,e){this.lastDisplayedStartPos=0;
this.div=c.parentNode;this.table=c;this.rowHeight=b;this.div.style.height=(this.rowHeight*d)+this.div.firstChild.offsetHeight+15+"px";this.buffer=a;this.liveGrid=e;this.visibleRows=d;this.lastPixelOffset=0;this.startPos=0;},updateHeight:function(){this.div.style.height=(this.rowHeight*this.liveGrid.visibleRows)+this.div.firstChild.offsetHeight+15+"px";
},populateRow:function(b,a){if(a){a.rowNode=b;a.updateGrid();}},bufferChanged:function(){this.refreshContents(parseInt(this.lastPixelOffset/this.rowHeight));},clearRows:function(){if(!this.isBlank){this.liveGrid.table.className=this.liveGrid.options.loadingClass;for(var a=0;a<this.visibleRows;a++){this.populateRow(this.table.rows[a],this.buffer.getBlankRow());
}this.isBlank=true;}},clearContents:function(){this.clearRows();this.scrollTo(0);this.startPos=0;this.lastStartPos=-1;},refreshContents:function(j){if(j==this.lastRowPos&&!this.isPartialBlank&&!this.isBlank){return;}if((j+this.visibleRows<this.buffer.startPos)||(this.buffer.startPos+this.buffer.size<j)||(this.buffer.size==0)){this.clearRows();
return;}try{setGridRefreshing(true);}catch(h){}this.isBlank=false;var g=this.buffer.startPos>j;var b=g?this.buffer.startPos:j;var a=(this.buffer.startPos+this.buffer.size<j+this.visibleRows)?this.buffer.startPos+this.buffer.size:j+this.visibleRows;var m=a-b;var n=this.buffer.getRows(b,m);var d=this.visibleRows-m;
var k=g?0:m;var c=g?d:0;for(var f=0;f<n.length;f++){this.populateRow(this.table.rows[f+c],n[f]);}for(var f=0;f<d;f++){this.populateRow(this.table.rows[f+k],this.buffer.getBlankRow());}this.isPartialBlank=d>0;this.lastRowPos=j;this.liveGrid.table.className=this.liveGrid.options.tableClass;var l=this.liveGrid.options.onRefreshComplete;
this.liveGrid.showSelection();if(l!=null){for(var f=0;f<l.length;f++){l[f]();}}try{setTimeout("setGridRefreshing(false);",50);}catch(h){}},scrollTo:function(a){if(this.lastPixelOffset==a){return;}this.refreshContents(parseInt(a/this.rowHeight));this.div.scrollTop=a%this.rowHeight;this.lastPixelOffset=a;
},visibleHeight:function(){var a=parseInt(dojo.getComputedStyle(this.div).height)-15-this.div.firstChild.offsetHeight;if(getBrowserInfo("name").toUpperCase().indexOf("CHROME")!=-1||getBrowserInfo("name").toUpperCase().indexOf("SAFARI")!=-1){if(parent.frameMenu){a=a+18;}else{a=a+1;}}return a;},convertSpaces:function(a){}});
dojo.declare("openbravo.widget.DataGrid.ContentRequest",null,{constructor:function(b,a){this.requestOffset=b;}});dojo.declare("openbravo.widget.DataGrid.SortingHandler",null,{constructor:function(b,a){this.headerTableId=b;this.headerTable=dojo.byId(b);this.options=a;this.setOptions();this.applySortBehavior();
this.sortColumns=[];if(this.options.sortCols){this.setSortUI(this.options.sortCols,this.options.sortDirs);}},setSortUI:function(d,a){for(var b=0;b<d.length;b++){var c=this.options.columns.get(d[b]);if(c){this.setColumnSort(c.index,a[b]);}}},setOptions:function(){new Image().src=this.options.sortAscendImg;
new Image().src=this.options.sortDescendImg;this.sort=this.options.sortHandler;},applySortBehavior:function(){var c=this.headerTable.rows[0];var a=c.cells;for(var b=0;b<a.length;b++){this.addSortBehaviorToColumn(b,a[b]);}},addSortBehaviorToColumn:function(b,a){if(this.options.columns.get(b).isSortable()){a.id=this.headerTableId+"_"+b;
a.style.cursor="pointer";dojo.connect(a,"onclick",this,"headerCellClicked");a.innerHTML='<span id="'+this.headerTableId+"_img_"+b+'"></span>'+a.innerHTML;}},headerCellClicked:function(a){if(this.options.hasResized()){return;}var e=openbravo.widget.DataGrid.html.getEventTarget(a);var d=e.id;var b=parseInt(d.substring(d.lastIndexOf("_")+1));
var c=this.options.columns.get(b);if(!c){return;}var f=c.isSorted();if(this.sortColumns.length>0){if(!f){if(!a.ctrlKey){this.removeAllColumnsSort();}this.setColumnSort(b,openbravo.widget.DataGrid.Column.SORT_ASC);}else{if(!a.ctrlKey){dojo.forEach(this.sortColumns,dojo.hitch(this,function(g){if(g!=c){this.removeColumnSort(g.index);
}}));}this.toggleColumnSort(b);}}else{this.setColumnSort(b,openbravo.widget.DataGrid.Column.SORT_ASC);}if(this.options.sortHandler){this.options.sortHandler(this.sortColumns);}},removeAllColumnsSort:function(){dojo.forEach(this.sortColumns,dojo.hitch(this,function(a){this.options.columns.get(a.index).setUnsorted();
this.setSortImage(a.index);}));this.sortColumns=[];},removeColumnSort:function(c){var b=this.options.columns.get(c);b.setUnsorted();var a=dojo.indexOf(this.sortColumns,b);this.sortColumns.splice(a,1);this.setSortImage(c);},setColumnSort:function(c,b){if(isNaN(c)){return;}var a=this.options.columns.get(c);
a.setSorted(b);this.sortColumns.push(a);this.setSortImage(c);},toggleColumnSort:function(a){this.options.columns.get(a).toggleSort();this.setSortImage(a);},setSortImage:function(c){var b=this.options.columns.get(c).getSortDirection();var a=dojo.byId(this.headerTableId+"_img_"+c);if(b==openbravo.widget.DataGrid.Column.UNSORTED){a.innerHTML="";
}else{if(b==openbravo.widget.DataGrid.Column.SORT_ASC){a.innerHTML='<div class="DataGrid_Header_icon_ascArrow"/>&nbsp;&nbsp;';}else{if(b==openbravo.widget.DataGrid.Column.SORT_DESC){a.innerHTML='<div class="DataGrid_Header_icon_descArrow"/>&nbsp;&nbsp;';}}}}});openbravo.widget.DataGrid.html={getEventTarget:function(a){if(!a){a=dojo.global.event||{};
}var b=(a.srcElement?a.srcElement:(a.target?a.target:null));while((b)&&(b.nodeType!=1)){b=b.parentNode;}return b;},getParentByType:function(d,c){var a=dojo.doc;var b=dojo.byId(d);c=c.toLowerCase();while((b)&&(b.nodeName.toLowerCase()!=c)){if(b==(a["body"]||a["documentElement"])){return null;}b=b.parentNode;
}return b;},getScrollbar:function(){var a=document.createElement("div");a.style.width="100px";a.style.height="100px";a.style.overflow="scroll";a.style.position="absolute";a.style.top="-300px";a.style.left="0px";var c=document.createElement("div");c.style.width="400px";c.style.height="400px";a.appendChild(c);
dojo.body().appendChild(a);var b=a.offsetWidth-a.clientWidth;dojo.body().removeChild(a);a.removeChild(c);a=c=null;return{width:b};},setVisibility:function(b,a){dojo.style(b,"visibility",((a instanceof String||typeof a=="string")?a:(a?"visible":"hidden")));},disableSelection:function(a){a=dojo.byId(a)||dojo.body();
if(dojo.isFF){a.style.MozUserSelect="none";}else{if(dojo.isSafari){a.style.KhtmlUserSelect="none";}else{if(dojo.isIE){a.unselectable="on";}else{return false;}}}return true;},enableSelection:function(a){a=dojo.byId(a)||dojo.body();if(dojo.isFF){a.style.MozUserSelect="";}else{if(dojo.isSafari){a.style.KhtmlUserSelect="";
}else{if(dojo.isIE){a.unselectable="off";}else{return false;}}}return true;},inArray:function(b,a){return dojo.indexOf(b,a)>-1;},toArray:function(d,b){var c=[];for(var a=b||0;a<d.length;a++){c.push(d[a]);}return c;},setContent:function(a,b){if(a.innerText!=undefined){a.innerText=b;}else{a.textContent=b;
}},prereplaceClass:function(b,c,a){if(dojo.hasClass(b,a)){dojo.removeClass(b,a);}if(!dojo.hasClass(b,c)){dojo.addClass(b,c);}},stripNbsp:function(a){return a;},extractPx:function(a){return parseInt(a.substring(0,a.indexOf("px")));},getContent:function(a){return a.innerText!=undefined?a.innerText:a.textContent;
},getContentAsString:function(a){if(typeof a.xml!="undefined"){return this.getContentAsStringIE(a);}else{if(typeof XMLSerializer!="undefined"){return this.getContentAsStringMozilla(a);}else{return this.getContentAsStringGeneric(a);}}},getContentAsStringIE:function(c){var b="";for(var a=0;a<c.childNodes.length;
a++){b+=c.childNodes[a].xml;}return b;},getContentAsStringMozilla:function(d){var a=new XMLSerializer();var c="";for(var b=0;b<d.childNodes.length;b++){c+=a.serializeToString(d.childNodes[b]);if(c=="undefined"){return this.getContentAsStringGeneric(d);}}return c;},getContentAsStringGeneric:function(c){var b="";
if(c==null){return b;}for(var a=0;a<c.childNodes.length;a++){switch(c.childNodes[a].nodeType){case 1:case 5:b+=this.getElementAsStringGeneric(c.childNodes[a]);break;case 3:case 2:case 4:b+=c.childNodes[a].nodeValue;break;default:break;}}return b;},getElementAsStringGeneric:function(c){if(!c){return"";
}var b="<"+c.nodeName;if(c.attributes&&c.attributes.length>0){for(var a=0;a<c.attributes.length;a++){b+=" "+c.attributes[a].name+'="'+c.attributes[a].value+'"';}}b+=">";b+=this.getContentAsStringGeneric(c);b+="</"+c.nodeName+">";return b;},clearElement:function(a){if(typeof(a)=="string"){a=dojo.byId(a);
}while(a.firstChild){a.removeChild(a.firstChild);}}};openbravo.widget.DataGrid.io={asyncCall:function(b,a){if(b.method=="GET"){dojo.xhrGet({url:b.url,preventCache:true,handleAs:b.handleAs,content:a,load:b.handler,error:openbravo.widget.DataGrid.io.handleError});}else{if(b.method=="POST"){dojo.xhrPost({url:b.url,preventCache:true,handleAs:b.handleAs,content:a,load:b.handler,error:openbravo.widget.DataGrid.io.handleError});
}}},handleError:function(c,a,b){if(c.status==0){return;}setValues_MessageBox("messageBoxID","ERROR","Error received in IO response:",c.message);}};