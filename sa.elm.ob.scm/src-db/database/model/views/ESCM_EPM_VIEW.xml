<?xml version="1.0"?>
  <database name="VIEW ESCM_EPM_VIEW">
    <view name="ESCM_EPM_VIEW"><![CDATA[SELECT epm.documentno AS contract_no, epm.group_orderno AS group_documentno, epm.negative_check AS project_intial_amount, COALESCE(epm.project_current_amount, 0) AS project_current_amount, epm.legacyrdv AS legacy_rdv_amount, epm.rdv_id, epm.rdv_createddate AS rdv_created_date, epm.rdv_txndate, epm.rdv_amount, epm.legacy_paid AS legacy_invoice_amount, epm.created AS invoice_date, epm.invoiceamount, epm.paid_amount, epm.contractstatus, epm.invoicestatus, epm.invoicetype FROM (SELECT ord.documentno, ord.documentno AS group_orderno, ordlegacy.negative_check, ordlegacy.project_current_amount, 0 AS legacyrdv, COALESCE(txnline.created) AS rdv_createddate, txnline.efin_rdvtxn_id AS rdv_id, COALESCE(txnline.txnver_date) AS rdv_txndate, COALESCE(txnline.netmatch_amt, 0) AS rdv_amount, 0 AS legacy_paid, inv.created, COALESCE(inv.grandtotal, 0) AS invoiceamount, COALESCE(sum(payment.amount) - COALESCE(inv.em_efin_tax_amount, 0), 0) AS paid_amount, ord.docstatus AS contractstatus, inv.docstatus AS invoicestatus, CASE WHEN txnline.efin_rdvtxn_id IS NOT NULL THEN 'RDV_Invoice' ELSE NULL END AS invoicetype FROM c_order ord JOIN escm_legacy_contract ordlegacy ON ordlegacy.escm_legacy_contract_id = ord.em_escm_legacycontract JOIN escm_ordermaxrevision_v maxrevision ON maxrevision.documentno = ord.documentno AND ord.em_escm_revision = maxrevision.max LEFT JOIN efin_rdv rdv ON rdv.c_order_id = ord.c_order_id OR rdv.c_order_id = ord.em_escm_old_order LEFT JOIN efin_rdvtxn txnline ON txnline.efin_rdv_id = rdv.efin_rdv_id LEFT JOIN c_invoice inv ON inv.c_invoice_id = txnline.c_invoice_id LEFT JOIN fin_payment payment ON payment.em_efin_invoice_id = inv.c_invoice_id AND (payment.status = 'PWNC' OR payment.status = 'PPM') GROUP BY ord.docstatus, ord.documentno, inv.docstatus, ordlegacy.negative_check, txnline.created, txnline.txnver_date, txnline.netmatch_amt, inv.created, inv.grandtotal, ordlegacy.project_current_amount, txnline.efin_rdvtxn_id, inv.em_efin_tax_amount UNION ALL SELECT ord.documentno, ''::character varying(30) AS group_orderno, ordlegacy1.negative_check, ordlegacy1.project_current_amount, sum(ordlegacy1.legacy_paid_amount) AS legacyrdv, NULL AS rdv_createddate, NULL AS rdv_id, NULL AS rdv_txndate, 0 AS rdv_amount, sum(ordlegacy1.legacy_paid_amount) AS legacy_paid, NULL AS "timestamp", 0 AS invoiceamount, sum(ordlegacy1.legacy_paid_amount) AS paid_amount, ord.docstatus AS contractstatus, NULL AS invoicestatus, 'Legacy' AS invoicetype FROM c_order ord JOIN escm_ordermaxrevision_v maxrevision ON maxrevision.documentno = ord.documentno AND ord.em_escm_revision = maxrevision.max JOIN escm_legacy_contract ordlegacy ON ordlegacy.escm_legacy_contract_id = ord.em_escm_legacycontract JOIN escm_legacy_contract ordlegacy1 ON ordlegacy.letter_no IS NOT NULL AND ordlegacy1.letter_no = ordlegacy.letter_no OR ordlegacy.award_no IS NOT NULL AND ordlegacy.letter_no IS NULL AND ordlegacy1.award_no = ordlegacy.award_no JOIN escm_legacymaxrevision_v maxlegacy ON maxlegacy.max = ordlegacy1.version_no AND maxlegacy.po_contract_no = ordlegacy1.po_contract_no GROUP BY ord.docstatus, ord.documentno, ordlegacy1.negative_check, ordlegacy1.project_current_amount UNION ALL SELECT ord.documentno, grouporder.documentno AS group_orderno, ordlegacy1.negative_check, ordlegacy1.project_current_amount, 0 AS legacyrdv, COALESCE(txnline.created) AS rdv_createddate, txnline.efin_rdvtxn_id AS rdv_id, COALESCE(txnline.txnver_date) AS rdv_txndate, COALESCE(txnline.netmatch_amt, 0) AS rdv_amount, 0 AS legacy_paid, inv.created, COALESCE(inv.grandtotal, 0) AS invoiceamount, COALESCE(sum(payment.amount) - COALESCE(inv.em_efin_tax_amount, 0), 0) AS paid_amount, grouporder.docstatus AS contractstatus, inv.docstatus AS invoicestatus, CASE WHEN txnline.efin_rdvtxn_id IS NOT NULL THEN 'RDV_Invoice' ELSE NULL END AS invoicetype FROM c_order ord JOIN escm_ordermaxrevision_v origmaxrevision ON origmaxrevision.documentno = ord.documentno AND ord.em_escm_revision = origmaxrevision.max JOIN escm_legacy_contract ordlegacy ON ordlegacy.escm_legacy_contract_id = ord.em_escm_legacycontract JOIN escm_legacy_contract ordlegacy1 ON ordlegacy.escm_legacy_contract_id <> ordlegacy1.escm_legacy_contract_id AND ordlegacy.letter_no IS NOT NULL AND ordlegacy1.letter_no = ordlegacy.letter_no OR ordlegacy.award_no IS NOT NULL AND ordlegacy.letter_no IS NULL AND ordlegacy1.award_no = ordlegacy.award_no JOIN c_order grouporder ON grouporder.em_escm_legacycontract = ordlegacy1.escm_legacy_contract_id AND grouporder.c_order_id <> ord.c_order_id JOIN escm_ordermaxrevision_v maxrevision ON maxrevision.documentno = grouporder.documentno AND grouporder.em_escm_revision = maxrevision.max LEFT JOIN efin_rdv rdv ON rdv.c_order_id = grouporder.c_order_id OR rdv.c_order_id = grouporder.em_escm_old_order LEFT JOIN efin_rdvtxn txnline ON txnline.efin_rdv_id = rdv.efin_rdv_id LEFT JOIN c_invoice inv ON inv.c_invoice_id = txnline.c_invoice_id LEFT JOIN fin_payment payment ON payment.em_efin_invoice_id = inv.c_invoice_id AND (payment.status = 'PWNC' OR payment.status = 'PPM') GROUP BY grouporder.docstatus, ord.documentno, inv.docstatus, ordlegacy1.negative_check, txnline.created, txnline.txnver_date, txnline.netmatch_amt, inv.created, inv.grandtotal, ordlegacy1.project_current_amount, grouporder.documentno, txnline.efin_rdvtxn_id, inv.em_efin_tax_amount UNION ALL SELECT ord.documentno, ord.documentno AS group_orderno, COALESCE(baseord.grandtotal, ord.grandtotal) AS "coalesce", ord.grandtotal, 0 AS legacyrdv, COALESCE(txnline.created) AS rdv_createddate, txnline.efin_rdvtxn_id AS rdv_id, COALESCE(txnline.txnver_date) AS rdv_txndate, COALESCE(txnline.netmatch_amt, 0) AS rdv_amount, 0 AS legacy_paid, inv.created, COALESCE(inv.grandtotal, 0) AS invoiceamount, COALESCE(sum(payment.amount) - COALESCE(inv.em_efin_tax_amount, 0), 0) AS paid_amount, ord.docstatus AS contractstatus, inv.docstatus AS invoicestatus, CASE WHEN txnline.efin_rdvtxn_id IS NOT NULL THEN 'RDV_Invoice' ELSE NULL END AS invoicetype FROM c_order ord JOIN escm_ordermaxrevision_v maxrevision ON maxrevision.documentno = ord.documentno AND ord.em_escm_revision = maxrevision.max LEFT JOIN c_order baseord ON baseord.c_order_id = ord.em_escm_base_order LEFT JOIN efin_rdv rdv ON rdv.c_order_id = ord.c_order_id OR rdv.c_order_id = ord.em_escm_old_order LEFT JOIN efin_rdvtxn txnline ON txnline.efin_rdv_id = rdv.efin_rdv_id LEFT JOIN c_invoice inv ON inv.c_invoice_id = txnline.c_invoice_id LEFT JOIN fin_payment payment ON payment.em_efin_invoice_id = inv.c_invoice_id AND (payment.status = 'PWNC' OR payment.status = 'PPM') WHERE ord.em_escm_legacycontract IS NULL GROUP BY ord.docstatus, ord.documentno, inv.docstatus, txnline.created, txnline.txnver_date, txnline.netmatch_amt, inv.created, inv.grandtotal, txnline.efin_rdvtxn_id, ord.grandtotal, inv.em_efin_tax_amount, baseord.grandtotal UNION ALL SELECT DISTINCT ord.documentno, ord.documentno AS group_orderno, ordlegacy.negative_check, ordlegacy.project_current_amount, 0 AS legacyrdv, NULL::timestamp without time zone AS rdv_createddate, inv.c_invoice_id AS rdv_id, NULL::timestamp without time zone AS rdv_txndate, 0 AS rdv_amount, 0 AS legacy_paid, inv.created, COALESCE(inv.grandtotal, 0) AS invoiceamount, COALESCE(sum(payment.amount) - COALESCE(inv.em_efin_tax_amount, 0), 0) AS paid_amount, ord.docstatus AS contractstatus, inv.docstatus AS invoicestatus, 'Direct' AS invoicetype FROM c_order ord JOIN escm_legacy_contract ordlegacy ON ordlegacy.escm_legacy_contract_id = ord.em_escm_legacycontract JOIN escm_ordermaxrevision_v maxrevision ON maxrevision.documentno = ord.documentno AND ord.em_escm_revision = maxrevision.max JOIN c_invoice inv ON ord.c_order_id = inv.em_efin_c_order_id OR ord.em_escm_old_order = inv.em_efin_c_order_id OR ord.em_escm_base_order = inv.em_efin_c_order_id JOIN fin_payment payment ON payment.em_efin_invoice_id = inv.c_invoice_id AND (payment.status = 'PWNC' OR payment.status = 'PPM') LEFT JOIN efin_rdvtxn rdv ON rdv.c_invoice_id = inv.c_invoice_id WHERE inv.grandtotal <> 0 AND rdv.efin_rdvtxn_id IS NULL GROUP BY ord.docstatus, ord.documentno, inv.docstatus, ordlegacy.negative_check, inv.created, inv.grandtotal, ordlegacy.project_current_amount, inv.em_efin_tax_amount, inv.c_invoice_id UNION ALL SELECT ord.documentno, grouporder.documentno AS group_orderno, ordlegacy1.negative_check, ordlegacy1.project_current_amount, 0 AS legacyrdv, NULL AS rdv_createddate, inv.c_invoice_id AS rdv_id, NULL AS rdv_txndate, 0 AS rdv_amount, 0 AS legacy_paid, inv.created, COALESCE(inv.grandtotal, 0) AS invoiceamount, COALESCE(sum(payment.amount) - COALESCE(inv.em_efin_tax_amount, 0), 0) AS paid_amount, grouporder.docstatus AS contractstatus, inv.docstatus AS invoicestatus, 'Direct' AS invoicetype FROM c_order ord JOIN escm_ordermaxrevision_v origmaxrevision ON origmaxrevision.documentno = ord.documentno AND ord.em_escm_revision = origmaxrevision.max JOIN escm_legacy_contract ordlegacy ON ordlegacy.escm_legacy_contract_id = ord.em_escm_legacycontract JOIN escm_legacy_contract ordlegacy1 ON ordlegacy.escm_legacy_contract_id <> ordlegacy1.escm_legacy_contract_id AND ordlegacy.letter_no IS NOT NULL AND ordlegacy1.letter_no = ordlegacy.letter_no OR ordlegacy.award_no IS NOT NULL AND ordlegacy.letter_no IS NULL AND ordlegacy1.award_no = ordlegacy.award_no JOIN c_order grouporder ON grouporder.em_escm_legacycontract = ordlegacy1.escm_legacy_contract_id AND grouporder.c_order_id <> ord.c_order_id LEFT JOIN escm_ordermaxrevision_v maxrevision ON maxrevision.documentno = grouporder.documentno AND grouporder.em_escm_revision = maxrevision.max JOIN c_invoice inv ON grouporder.c_order_id = inv.em_efin_c_order_id JOIN fin_payment payment ON payment.em_efin_invoice_id = inv.c_invoice_id AND (payment.status = 'PWNC' OR payment.status = 'PPM') LEFT JOIN efin_rdvtxn rdv ON rdv.c_invoice_id = inv.c_invoice_id WHERE inv.grandtotal <> 0 AND rdv.efin_rdvtxn_id IS NULL GROUP BY grouporder.docstatus, ord.documentno, inv.docstatus, ordlegacy1.negative_check, inv.created, inv.grandtotal, ordlegacy1.project_current_amount, grouporder.documentno, inv.em_efin_tax_amount, inv.c_invoice_id) epm ORDER BY epm.documentno]]></view>
  </database>
