<?xml version="1.0"?>
  <database name="VIEW EFIN_ENCUMBRANCE_HISTORY_V">
    <view name="EFIN_ENCUMBRANCE_HISTORY_V"><![CDATA[SELECT get_uuid() AS efin_encumbrance_history_v_id, t1.ad_client_id, t1.ad_org_id, t1.isactive, t1.created, t1.createdby, t1.updated, t1.updatedby, CASE WHEN enc.encum_stage = 'PAE' THEN ppl.line_total WHEN enc.encum_stage = 'POE' THEN oln.linenetamt ELSE prl.linenetamt END AS amount, CASE WHEN pr.em_escm_doc_status = 'ESCM_CA' THEN 'CA' WHEN pr.em_escm_doc_status = 'ESCM_RA' THEN 'REA' ELSE pr.em_escm_doc_status END AS status, pr.documentno, t1.efin_budget_manencumlines_id, COALESCE(prl.m_requisitionline_id, '') AS m_requisitionline_id, COALESCE(bdl.escm_bidmgmt_line_id, '') AS escm_bidmgmt_line_id, COALESCE(oln.c_orderline_id, '') AS c_orderline_id, COALESCE(ppl.escm_proposalmgmt_line_id, '') AS escm_proposalmgmt_line_id, COALESCE(invln.c_invoiceline_id, '') AS c_invoiceline_id, enc.efin_budgetint_id FROM efin_budget_manencumlines t1 JOIN efin_budget_manencum enc ON t1.efin_budget_manencum_id = enc.efin_budget_manencum_id LEFT JOIN m_requisitionline prl ON prl.em_efin_bud_encumlines_id = t1.efin_budget_manencumlines_id LEFT JOIN m_requisition pr ON pr.m_requisition_id = prl.m_requisition_id LEFT JOIN escm_bidmgmt_line bdl ON bdl.em_efin_budgmanencumline_id = t1.efin_budget_manencumlines_id LEFT JOIN escm_bidmgmt bd ON bdl.escm_bidmgmt_id = bd.escm_bidmgmt_id LEFT JOIN c_orderline oln ON oln.em_efin_bud_encumlines_id = t1.efin_budget_manencumlines_id LEFT JOIN c_order ord ON oln.c_order_id = ord.c_order_id LEFT JOIN escm_proposalmgmt_line ppl ON ppl.em_efin_budgmanencumline_id = t1.efin_budget_manencumlines_id LEFT JOIN escm_proposalmgmt pm ON ppl.escm_proposalmgmt_id = pm.escm_proposalmgmt_id LEFT JOIN c_invoiceline invln ON invln.em_efin_budgmanuencumln_id = t1.efin_budget_manencumlines_id LEFT JOIN c_invoice inv ON invln.c_invoice_id = inv.c_invoice_id WHERE enc.encum_type = 'PRE' AND (t1.app_amt > 0 OR (t1.enc_decrease > 0 OR t1.enc_increase > 0) AND (t1.efin_budget_manencumlines_id IN (SELECT rev.efin_budget_manencumlines_id FROM efin_bud_manencum_rev rev WHERE rev.efin_budget_manencumlines_id = t1.efin_budget_manencumlines_id AND rev.isauto = 'Y'))) UNION SELECT get_uuid() AS efin_encumbrance_history_v_id, t1.ad_client_id, t1.ad_org_id, t1.isactive, t1.created, t1.createdby, t1.updated, t1.updatedby, (SELECT CASE WHEN COALESCE(sum(reln.qty), 0) > 0 THEN sum(round(COALESCE(reln.priceactual, 0) * COALESCE(ref.quantity, 0), 2)) ELSE 0 END AS "case" FROM escm_bidsourceref ref JOIN escm_bidmgmt_line ln ON ln.escm_bidmgmt_line_id = ref.escm_bidmgmt_line_id JOIN m_requisitionline reln ON reln.m_requisitionline_id = ref.m_requisitionline_id WHERE ln.em_efin_budgmanencumline_id = t1.efin_budget_manencumlines_id GROUP BY t1.efin_budget_manencumlines_id) AS amount, CASE WHEN bd.bidappstatus = 'ESCM_CA' THEN 'CA' WHEN bd.bidappstatus = 'ESCM_RA' THEN 'REA' ELSE bd.bidappstatus END AS status, bd.bidno AS documentno, t1.efin_budget_manencumlines_id, COALESCE(prl.m_requisitionline_id, '') AS m_requisitionline_id, COALESCE(bdl.escm_bidmgmt_line_id, '') AS escm_bidmgmt_line_id, COALESCE(oln.c_orderline_id, '') AS c_orderline_id, CASE WHEN pm.em_efin_isbudgetcntlapp = 'Y' THEN COALESCE(ppl.escm_proposalmgmt_line_id, '') ELSE '' END AS escm_proposalmgmt_line_id, COALESCE(invln.c_invoiceline_id, '') AS c_invoiceline_id, enc.efin_budgetint_id FROM efin_budget_manencumlines t1 JOIN efin_budget_manencum enc ON t1.efin_budget_manencum_id = enc.efin_budget_manencum_id LEFT JOIN escm_bidmgmt_line bdl ON bdl.em_efin_budgmanencumline_id = t1.efin_budget_manencumlines_id LEFT JOIN escm_bidmgmt bd ON bdl.escm_bidmgmt_id = bd.escm_bidmgmt_id LEFT JOIN c_orderline oln ON oln.em_efin_bud_encumlines_id = t1.efin_budget_manencumlines_id LEFT JOIN c_order ord ON oln.c_order_id = ord.c_order_id LEFT JOIN escm_proposalmgmt_line ppl ON ppl.em_efin_budgmanencumline_id = t1.efin_budget_manencumlines_id LEFT JOIN escm_proposalmgmt pm ON ppl.escm_proposalmgmt_id = pm.escm_proposalmgmt_id AND pm.em_efin_isbudgetcntlapp = 'Y' LEFT JOIN m_requisitionline prl ON prl.em_efin_bud_encumlines_id = t1.efin_budget_manencumlines_id LEFT JOIN m_requisition pr ON pr.m_requisition_id = prl.m_requisition_id LEFT JOIN c_invoiceline invln ON invln.em_efin_budgmanuencumln_id = t1.efin_budget_manencumlines_id LEFT JOIN c_invoice inv ON invln.c_invoice_id = inv.c_invoice_id WHERE enc.encum_type = 'BE' AND (t1.app_amt > 0 OR (t1.enc_decrease > 0 OR t1.enc_increase > 0) AND (t1.efin_budget_manencumlines_id IN (SELECT rev.efin_budget_manencumlines_id FROM efin_bud_manencum_rev rev WHERE rev.efin_budget_manencumlines_id = t1.efin_budget_manencumlines_id AND rev.isauto = 'Y'))) UNION SELECT get_uuid() AS efin_encumbrance_history_v_id, t1.ad_client_id, t1.ad_org_id, t1.isactive, t1.created, t1.createdby, t1.updated, t1.updatedby, oln.linenetamt AS amount, CASE WHEN ord.em_escm_appstatus = 'ESCM_CA' THEN 'CA' WHEN ord.em_escm_appstatus = 'ESCM_RA' THEN 'REA' ELSE ord.em_escm_appstatus END AS status, ord.documentno, t1.efin_budget_manencumlines_id, COALESCE(prl.m_requisitionline_id, '') AS m_requisitionline_id, COALESCE(bdl.escm_bidmgmt_line_id, '') AS escm_bidmgmt_line_id, COALESCE(oln.c_orderline_id, '') AS c_orderline_id, COALESCE(ppl.escm_proposalmgmt_line_id, '') AS escm_proposalmgmt_line_id, COALESCE(invln.c_invoiceline_id, '') AS c_invoiceline_id, enc.efin_budgetint_id FROM efin_budget_manencumlines t1 JOIN efin_budget_manencum enc ON t1.efin_budget_manencum_id = enc.efin_budget_manencum_id LEFT JOIN c_orderline oln ON oln.em_efin_bud_encumlines_id = t1.efin_budget_manencumlines_id LEFT JOIN c_order ord ON oln.c_order_id = ord.c_order_id LEFT JOIN escm_proposalmgmt_line ppl ON ppl.em_efin_budgmanencumline_id = t1.efin_budget_manencumlines_id LEFT JOIN escm_proposalmgmt pm ON ppl.escm_proposalmgmt_id = pm.escm_proposalmgmt_id LEFT JOIN escm_bidmgmt_line bdl ON bdl.em_efin_budgmanencumline_id = t1.efin_budget_manencumlines_id LEFT JOIN escm_bidmgmt bd ON bdl.escm_bidmgmt_id = bd.escm_bidmgmt_id LEFT JOIN m_requisitionline prl ON prl.em_efin_bud_encumlines_id = t1.efin_budget_manencumlines_id LEFT JOIN m_requisition pr ON pr.m_requisition_id = prl.m_requisition_id LEFT JOIN c_invoiceline invln ON invln.em_efin_budgmanuencumln_id = t1.efin_budget_manencumlines_id LEFT JOIN c_invoice inv ON invln.c_invoice_id = inv.c_invoice_id WHERE enc.encum_type = 'POE' AND oln.em_efin_bud_encumlines_id IS NOT NULL AND (t1.app_amt > 0 OR (t1.enc_decrease > 0 OR t1.enc_increase > 0) AND (t1.efin_budget_manencumlines_id IN (SELECT rev.efin_budget_manencumlines_id FROM efin_bud_manencum_rev rev WHERE rev.efin_budget_manencumlines_id = t1.efin_budget_manencumlines_id AND rev.isauto = 'Y'))) UNION SELECT get_uuid() AS efin_encumbrance_history_v_id, t1.ad_client_id, t1.ad_org_id, t1.isactive, t1.created, t1.createdby, t1.updated, t1.updatedby, CASE WHEN enc.encum_stage = 'POE' THEN oln.linenetamt ELSE ppl.line_total END AS amount, CASE WHEN pm.proposalstatus = 'CL' THEN 'CA' WHEN pm.proposalstatus = 'WD' THEN 'CA' WHEN pm.proposalstatus = 'DIS' THEN 'CA' ELSE pm.proposalstatus END AS status, pm.proposalno AS documentno, t1.efin_budget_manencumlines_id, COALESCE(prl.m_requisitionline_id, '') AS m_requisitionline_id, COALESCE(bdl.escm_bidmgmt_line_id, '') AS escm_bidmgmt_line_id, COALESCE(oln.c_orderline_id, '') AS c_orderline_id, COALESCE(ppl.escm_proposalmgmt_line_id, '') AS escm_proposalmgmt_line_id, COALESCE(invln.c_invoiceline_id, '') AS c_invoiceline_id, enc.efin_budgetint_id FROM efin_budget_manencumlines t1 JOIN efin_budget_manencum enc ON t1.efin_budget_manencum_id = enc.efin_budget_manencum_id LEFT JOIN escm_proposalmgmt_line ppl ON ppl.em_efin_budgmanencumline_id = t1.efin_budget_manencumlines_id LEFT JOIN escm_proposalmgmt pm ON ppl.escm_proposalmgmt_id = pm.escm_proposalmgmt_id LEFT JOIN c_orderline oln ON oln.em_efin_bud_encumlines_id = t1.efin_budget_manencumlines_id LEFT JOIN c_order ord ON oln.c_order_id = ord.c_order_id LEFT JOIN escm_bidmgmt_line bdl ON bdl.em_efin_budgmanencumline_id = t1.efin_budget_manencumlines_id LEFT JOIN escm_bidmgmt bd ON bdl.escm_bidmgmt_id = bd.escm_bidmgmt_id LEFT JOIN m_requisitionline prl ON prl.em_efin_bud_encumlines_id = t1.efin_budget_manencumlines_id LEFT JOIN m_requisition pr ON pr.m_requisition_id = prl.m_requisition_id LEFT JOIN c_invoiceline invln ON invln.em_efin_budgmanuencumln_id = t1.efin_budget_manencumlines_id LEFT JOIN c_invoice inv ON invln.c_invoice_id = inv.c_invoice_id WHERE enc.encum_type = 'PAE' AND (t1.app_amt > 0 OR (t1.enc_decrease > 0 OR t1.enc_increase > 0) AND (t1.efin_budget_manencumlines_id IN (SELECT rev.efin_budget_manencumlines_id FROM efin_bud_manencum_rev rev WHERE rev.efin_budget_manencumlines_id = t1.efin_budget_manencumlines_id AND rev.isauto = 'Y'))) UNION SELECT get_uuid() AS efin_encumbrance_history_v_id, el.ad_client_id, el.ad_org_id, el.isactive, el.created, el.createdby, el.updated, el.updatedby, il.linenetamt AS amount, i.docstatus AS status, i.documentno, el.efin_budget_manencumlines_id, '' AS m_requisitionline_id, '' AS escm_bidmgmt_line_id, '' AS c_orderline_id, '' AS escm_proposalmgmt_line_id, COALESCE(il.c_invoiceline_id, '') AS c_invoiceline_id, e.efin_budgetint_id FROM efin_manualencuminvoice mi JOIN c_invoice i ON i.c_invoice_id = mi.c_invoice_id JOIN c_invoiceline il ON i.c_invoice_id = il.c_invoice_id JOIN efin_budget_manencumlines el ON el.efin_budget_manencumlines_id = mi.efin_budget_manencumlines_id AND el.c_validcombination_id = il.em_efin_c_validcombination_id JOIN efin_budget_manencum e ON e.efin_budget_manencum_id = el.efin_budget_manencum_id JOIN c_campaign bt ON bt.c_campaign_id = e.c_campaign_id WHERE mi.ispaid = 'N' UNION SELECT efin_encumref_clos_his.efin_encumref_clos_his_id AS efin_encumbrance_history_v_id, efin_encumref_clos_his.ad_client_id, efin_encumref_clos_his.ad_org_id, efin_encumref_clos_his.isactive, efin_encumref_clos_his.created, efin_encumref_clos_his.createdby, efin_encumref_clos_his.updated, efin_encumref_clos_his.updatedby, efin_encumref_clos_his.amount, efin_encumref_clos_his.status, efin_encumref_clos_his.documentno, efin_encumref_clos_his.efin_budget_manencumlines_id, efin_encumref_clos_his.m_requisitionline_id, efin_encumref_clos_his.escm_bidmgmt_line_id, efin_encumref_clos_his.c_orderline_id, efin_encumref_clos_his.escm_proposalmgmt_line_id, efin_encumref_clos_his.c_invoiceline_id, efin_encumref_clos_his.efin_budgetint_id FROM efin_encumref_clos_his]]></view>
  </database>
