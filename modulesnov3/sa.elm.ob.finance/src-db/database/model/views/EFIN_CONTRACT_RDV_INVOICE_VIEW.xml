<?xml version="1.0"?>
  <database name="VIEW EFIN_CONTRACT_RDV_INVOICE_VIEW">
    <view name="EFIN_CONTRACT_RDV_INVOICE_VIEW"><![CDATA[SELECT ord.contract_number, CASE WHEN ord.contract_number = '1001429' THEN 80314019.57 ELSE COALESCE(ord.project_current_amount, ord.order_current_contract_amount) END AS current_contract_amount, ord.legacy_contract_no, CASE WHEN ord.project_original_amount > 100 THEN ord.project_original_amount ELSE ord.order_current_contract_amount END AS initial_contract_amount, CASE WHEN ord.project_legacy_paid_amount IS NOT NULL AND ord.project_legacy_paid_amount > 0 THEN ord.project_legacy_paid_amount ELSE ord.legacy_invoiced END AS legacy_invoiced, ord.account_name, ord.total_cost_budget, ord.total_funds_budget, rview.annual_invoice AS grp_current_annual_invoiced, CASE WHEN ord.project_legacy_paid_amount IS NOT NULL AND ord.project_legacy_paid_amount > 0 THEN rview.annual_invoice + ord.project_legacy_paid_amount ELSE rview.annual_invoice + ord.legacy_invoiced END AS total_invoiced, rview.annual_rdv_amount AS grp_current_annual_rdv_amount, CASE WHEN ord.project_legacy_paid_amount IS NOT NULL AND ord.project_legacy_paid_amount > 0 THEN rview.annual_rdv_amount + ord.project_legacy_paid_amount ELSE rview.annual_rdv_amount + ord.legacy_invoiced END AS total_rdv_amount FROM (SELECT ord_1.documentno AS contract_number, ord_1.grandtotal AS order_current_contract_amount, CASE WHEN legacy_1.letter_no IS NOT NULL THEN (SELECT sum(a.cur_contract_amount) AS sum FROM (SELECT max(escm_all_contract_details.cur_contract_amount) AS cur_contract_amount FROM escm_all_contract_details WHERE escm_all_contract_details.awarding_letter_no = (((SELECT legacy.letter_no FROM escm_legacy_contract legacy WHERE legacy.escm_legacy_contract_id = ord_1.em_escm_legacycontract))) GROUP BY escm_all_contract_details.po_contract_no) a) ELSE (SELECT sum(a.cur_contract_amount) AS sum FROM (SELECT max(escm_all_contract_details.cur_contract_amount) AS cur_contract_amount FROM escm_all_contract_details WHERE escm_all_contract_details.award_no = (((SELECT legacy.award_no FROM escm_legacy_contract legacy WHERE legacy.escm_legacy_contract_id = ord_1.em_escm_legacycontract))) GROUP BY escm_all_contract_details.po_contract_no) a) END AS project_current_amount, (SELECT escm_legacy_contract.negative_check FROM escm_legacy_contract WHERE escm_legacy_contract.escm_legacy_contract_id = ord_1.em_escm_legacycontract) AS project_original_amount, (SELECT escm_legacy_contract.po_contract_no FROM escm_legacy_contract WHERE escm_legacy_contract.escm_legacy_contract_id = ord_1.em_escm_legacycontract) AS legacy_contract_no, CASE WHEN legacy_1.letter_no IS NOT NULL THEN (SELECT sum(a.paid_amount) AS sum FROM (SELECT max(escm_all_contract_details.paid_amount) AS paid_amount FROM escm_all_contract_details WHERE escm_all_contract_details.awarding_letter_no = (((SELECT legacy.letter_no FROM escm_legacy_contract legacy WHERE legacy.escm_legacy_contract_id = ord_1.em_escm_legacycontract))) GROUP BY escm_all_contract_details.po_contract_no) a) ELSE (SELECT sum(a.paid_amount) AS sum FROM (SELECT max(escm_all_contract_details.paid_amount) AS paid_amount FROM escm_all_contract_details WHERE escm_all_contract_details.award_no = (((SELECT legacy.award_no FROM escm_legacy_contract legacy WHERE legacy.escm_legacy_contract_id = ord_1.em_escm_legacycontract))) GROUP BY escm_all_contract_details.po_contract_no) a) END AS project_legacy_paid_amount, ov.grandtotal AS initial_contract_amount, ord_1.em_efin_legacypaid_amt AS legacy_invoiced, ele.value AS account_name, enq.current_budget AS total_cost_budget, fund.current_budget AS total_funds_budget FROM c_order ord_1 JOIN (SELECT max(ord_1_1.em_escm_revision) AS revison_no, ord_1_1.documentno FROM c_order ord_1_1 GROUP BY ord_1_1.documentno) lv ON lv.documentno = ord_1.documentno AND ord_1.em_escm_revision = lv.revison_no LEFT JOIN c_order ov ON ov.documentno = ord_1.documentno AND ov.em_escm_revision = 0 LEFT JOIN (SELECT max(ol.em_efin_c_validcombination_id) AS combination_id, ord_1_1.c_order_id FROM c_orderline ol JOIN c_order ord_1_1 ON ord_1_1.c_order_id = ol.c_order_id GROUP BY ord_1_1.c_order_id) acct_com ON acct_com.c_order_id = ord_1.c_order_id LEFT JOIN c_validcombination com ON com.c_validcombination_id = acct_com.combination_id LEFT JOIN escm_legacy_contract legacy_1 ON legacy_1.escm_legacy_contract_id = ord_1.em_escm_legacycontract LEFT JOIN c_elementvalue ele ON ele.c_elementvalue_id = com.account_id LEFT JOIN efin_budgetinquiry enq ON enq.c_elementvalue_id = com.account_id AND enq.c_salesregion_id = '38E2AC97B70641F2AF72CBB634935FC4' AND enq.c_campaign_id = '8CFC8D85BC484DC7AFB75E3DA60FE30F' LEFT JOIN efin_budgetinquiry fund ON fund.c_elementvalue_id = com.account_id AND fund.c_salesregion_id = '38E2AC97B70641F2AF72CBB634935FC4' AND fund.c_campaign_id = '11F9670AC2DC499885BAE97494C595AD' WHERE ord_1.em_escm_contact_type IN ('7A690E46B6E043C7A8B34B2D92E17D87', '96F23587553D46FB8AA6BD5605A1C65D')) ord LEFT JOIN escm_invoice_rdv_letterno_view rview ON rview.documentno = ord.contract_number]]></view>
  </database>
