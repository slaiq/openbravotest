<?xml version="1.0"?>
  <database name="VIEW ESCM_PO_RETURN_V">
    <view name="ESCM_PO_RETURN_V"><![CDATA[SELECT a.escm_po_return_v_id, a.escm_initialreceipt_id, a.m_inout_id, a.ad_client_id, a.ad_org_id, a.isactive, a.created, a.createdby, a.updated, a.updatedby, COALESCE(a.quantity, 0) AS quantity, a.newquantity, a.status, a.m_product_id, a.description, a.c_uom_id, a.supplierbatch, COALESCE(a.notes, '') AS notes, a.warehouse, a.delref, a.delspecno, a.issummary, a.custody_item FROM (SELECT get_uuid() AS escm_po_return_v_id, l1.escm_initialreceipt_id, addrec.m_inout_id, l1.ad_client_id, l1.ad_org_id, l1.isactive, l1.created, l1.createdby, l1.updated, l1.updatedby, COALESCE(COALESCE(l1.quantity, 0) - (COALESCE(l1.accepted_qty, 0) + COALESCE(l1.rejected_qty, 0) + COALESCE(l1.delivered_qty, 0) + COALESCE(l1.return_qty, 0) + COALESCE(l1.ir_return_qty, 0)), 0) AS quantity, COALESCE(newiniti.quantity, 0) AS newquantity, 'I' AS status, l1.m_product_id, l1.description, l1.c_uom_id, l1.supplierbatch, COALESCE(newiniti.notes, '') AS notes, '' AS warehouse, '' AS delref, '' AS delspecno, l1.issummary, l1.custody_item FROM escm_initialreceipt l1 LEFT JOIN (SELECT DISTINCT addrec_1.receipt, addrec_1.m_inout_id FROM escm_addreceipt addrec_1) addrec ON l1.m_inout_id = addrec.receipt LEFT JOIN escm_initialreceipt newiniti ON newiniti.m_inout_id = addrec.m_inout_id AND newiniti.m_product_id = l1.m_product_id AND newiniti.status = 'I' AND newiniti.source_ref = l1.escm_initialreceipt_id LEFT JOIN m_product pro ON pro.m_product_id = l1.m_product_id WHERE (COALESCE(l1.quantity, 0) - (COALESCE(l1.accepted_qty, 0) + COALESCE(l1.rejected_qty, 0) + COALESCE(l1.delivered_qty, 0) + COALESCE(l1.return_qty, 0) + COALESCE(l1.ir_return_qty, 0))) > 0 AND pro.producttype = 'I' AND pro.isstocked = 'Y' UNION ALL SELECT get_uuid() AS escm_po_return_v_id, l2.escm_initialreceipt_id, addrec.m_inout_id, l2.ad_client_id, l2.ad_org_id, l2.isactive, l2.created, l2.createdby, l2.updated, l2.updatedby, CASE WHEN COALESCE(l2.accepted_qty, 0) > 0 THEN l2.accepted_qty ELSE 0 END AS quantity, COALESCE(newiniti.quantity, 0) AS newquantity, 'A' AS status, l2.m_product_id, l2.description, l2.c_uom_id, l2.supplierbatch, COALESCE(newiniti.notes, '') AS notes, '' AS warehouse, '' AS delref, '' AS delspecno, l2.issummary, l2.custody_item FROM escm_initialreceipt l2 LEFT JOIN (SELECT DISTINCT addrec_1.receipt, addrec_1.m_inout_id FROM escm_addreceipt addrec_1) addrec ON l2.m_inout_id = addrec.receipt LEFT JOIN escm_initialreceipt newiniti ON newiniti.m_inout_id = addrec.m_inout_id AND newiniti.m_product_id = l2.m_product_id AND newiniti.status = 'A' AND newiniti.source_ref = l2.escm_initialreceipt_id LEFT JOIN m_product pro ON pro.m_product_id = l2.m_product_id WHERE l2.accepted_qty > 0 AND (pro.producttype = 'I' AND pro.isstocked = 'Y' OR pro.m_product_id IS NULL) UNION ALL SELECT get_uuid() AS escm_po_return_v_id, l3.escm_initialreceipt_id, addrec.m_inout_id, l3.ad_client_id, l3.ad_org_id, l3.isactive, l3.created, l3.createdby, l3.updated, l3.updatedby, CASE WHEN COALESCE(l3.rejected_qty, 0) > 0 THEN l3.rejected_qty ELSE 0 END AS quantity, COALESCE(newiniti.quantity, 0) AS newquantity, 'R' AS status, l3.m_product_id, l3.description, l3.c_uom_id, l3.supplierbatch, COALESCE(newiniti.notes, '') AS notes, '' AS warehouse, '' AS delref, '' AS delspecno, l3.issummary, l3.custody_item FROM escm_initialreceipt l3 LEFT JOIN (SELECT DISTINCT addrec_1.receipt, addrec_1.m_inout_id FROM escm_addreceipt addrec_1) addrec ON l3.m_inout_id = addrec.receipt LEFT JOIN escm_initialreceipt newiniti ON newiniti.m_inout_id = addrec.m_inout_id AND newiniti.m_product_id = l3.m_product_id AND newiniti.status = 'R' AND newiniti.source_ref = l3.escm_initialreceipt_id JOIN m_product pro ON pro.m_product_id = l3.m_product_id WHERE l3.rejected_qty > 0 AND (pro.producttype = 'I' AND pro.isstocked = 'Y' OR pro.m_product_id IS NULL) UNION ALL SELECT get_uuid() AS escm_po_return_v_id, rec.escm_initialreceipt_id, addrec.m_inout_id, l4.ad_client_id, l4.ad_org_id, l4.isactive, l4.created, l4.createdby, l4.updated, l4.updatedby, CASE WHEN COALESCE(l4.quantity - COALESCE(ret.retqty, 0), 0) > 0 THEN l4.quantity - COALESCE(ret.retqty, 0) ELSE 0 END AS quantity, COALESCE(retu.quantity, 0) AS newquantity, 'D' AS status, l4.m_product_id, l4.description, l4.c_uom_id, l4.supplierbatch, COALESCE(retu.notes, '') AS notes, hd.m_warehouse_id AS warehouse, l4.escm_initialreceipt_id AS delref, hd.documentno AS delspecno, l4.issummary, l4.custody_item FROM escm_initialreceipt l4 LEFT JOIN (SELECT DISTINCT addrec_1.delivery, addrec_1.m_inout_id FROM escm_addreceipt addrec_1) addrec ON l4.m_inout_id = addrec.delivery LEFT JOIN escm_initialreceipt rec ON rec.escm_initialreceipt_id = l4.source_ref LEFT JOIN m_inout hd ON hd.m_inout_id = l4.m_inout_id LEFT JOIN escm_initialreceipt retu ON retu.m_inout_id = addrec.m_inout_id AND retu.m_product_id = l4.m_product_id AND retu.status = 'D' AND retu.deliver_ref = l4.escm_initialreceipt_id LEFT JOIN (SELECT COALESCE(sum(ret_1.quantity), 0) AS retqty, ret_1.deliver_ref, ret_1.m_product_id FROM escm_initialreceipt ret_1 JOIN m_inout hdinout ON hdinout.m_inout_id = ret_1.m_inout_id WHERE ret_1.deliver_ref IS NOT NULL AND hdinout.em_escm_docstatus = 'CO' GROUP BY ret_1.deliver_ref, ret_1.m_product_id) ret ON ret.deliver_ref = l4.escm_initialreceipt_id AND ret.m_product_id = l4.m_product_id JOIN m_product pro ON pro.m_product_id = l4.m_product_id WHERE rec.delivered_qty > 0 AND (pro.producttype = 'I' AND pro.isstocked = 'Y' OR pro.m_product_id IS NULL) UNION ALL SELECT get_uuid() AS escm_po_return_v_id, l4.escm_initialreceipt_id, addrec.m_inout_id, l4.ad_client_id, l4.ad_org_id, l4.isactive, l4.created, l4.createdby, l4.updated, l4.updatedby, CASE WHEN (COALESCE(l4.delivered_qty, 0) - COALESCE(l4.sitereqissuedqty, 0)) > 0 THEN COALESCE(l4.delivered_qty, 0) - COALESCE(l4.sitereqissuedqty, 0) ELSE 0 END AS quantity, COALESCE(newiniti.quantity, 0) AS newquantity, 'D' AS status, l4.m_product_id, l4.description, l4.c_uom_id, l4.supplierbatch, COALESCE(newiniti.notes, '') AS notes, '' AS warehouse, '' AS delref, '' AS delspecno, l4.issummary, l4.custody_item FROM escm_initialreceipt l4 JOIN m_inout hd ON hd.m_inout_id = l4.m_inout_id LEFT JOIN (SELECT DISTINCT addrec_1.receipt, addrec_1.m_inout_id FROM escm_addreceipt addrec_1) addrec ON l4.m_inout_id = addrec.receipt LEFT JOIN escm_initialreceipt newiniti ON newiniti.m_inout_id = addrec.m_inout_id AND newiniti.m_product_id = l4.m_product_id AND newiniti.status = 'D' AND newiniti.source_ref = l4.escm_initialreceipt_id JOIN m_product pro ON pro.m_product_id = l4.m_product_id WHERE l4.delivered_qty > 0 AND hd.em_escm_receivingtype = 'SR' AND hd.em_escm_receivetype = 'QTY' AND (pro.producttype = 'I' AND pro.isstocked = 'Y' OR pro.m_product_id IS NULL)) a WHERE a.quantity > 0]]></view>
  </database>
