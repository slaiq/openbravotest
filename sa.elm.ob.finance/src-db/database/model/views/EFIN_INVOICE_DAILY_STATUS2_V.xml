<?xml version="1.0"?>
  <database name="VIEW EFIN_INVOICE_DAILY_STATUS2_V">
    <view name="EFIN_INVOICE_DAILY_STATUS2_V"><![CDATA[SELECT CASE WHEN main.em_efin_classification_ar IS NULL THEN 'أخرى' ELSE main.em_efin_classification_ar END AS em_efin_classification_ar, round(sum(main.completed_invoices)) AS inv_amt_comp, round(sum(main.inprogress_invoices)) AS inv_amt_in_prog, sum(main.wt_appr_invoices) AS inv_amt_wt_appr, sum(main.draft_invoices) AS inv_amt_draft, sum(main.completed_invoices_cnt) AS completed_invoices_cnt, sum(main.inprogress_invoices_cnt) AS inprogress_invoices_cnt, sum(main.draft_invoices_cnt) AS draft_invoices_cnt, sum(main.wt_appr_invoices_cnt) AS wt_appr_invoices_cnt, main.fin_year FROM (SELECT inv.fin_year, e.em_efin_main_classification, e.em_efin_classification_ar, CASE WHEN inv.docstatus = 'CO' THEN sum(inv.linenetamt) ELSE 0 END AS completed_invoices, CASE WHEN inv.docstatus IN ('EFIN_WFA', 'DR') THEN sum(inv.linenetamt) ELSE 0 END AS inprogress_invoices, CASE WHEN inv.docstatus = 'DR' THEN sum(inv.linenetamt) ELSE 0 END AS draft_invoices, CASE WHEN inv.docstatus = 'EFIN_WFA' THEN sum(inv.linenetamt) ELSE 0 END AS wt_appr_invoices, CASE WHEN inv.docstatus = 'CO' THEN count(DISTINCT inv.documentno) ELSE 0 END AS completed_invoices_cnt, CASE WHEN inv.docstatus IN ('EFIN_WFA', 'DR') THEN count(DISTINCT inv.documentno) ELSE 0 END AS inprogress_invoices_cnt, CASE WHEN inv.docstatus = 'DR' THEN count(DISTINCT inv.documentno) ELSE 0 END AS draft_invoices_cnt, CASE WHEN inv.docstatus = 'EFIN_WFA' THEN count(DISTINCT inv.documentno) ELSE 0 END AS wt_appr_invoices_cnt FROM c_elementvalue e LEFT JOIN (SELECT invl.em_efin_c_elementvalue_id, inv_1.docstatus, invl.linenetamt * CASE WHEN inv_1.c_currency_id = '317' THEN 1 ELSE COALESCE((SELECT c_conversion_rate.multiplyrate FROM c_conversion_rate WHERE c_conversion_rate.c_currency_id = inv_1.c_currency_id), 1) END AS linenetamt, inv_1.dateinvoiced, inv_1.documentno, hist.created AS approved_date, yr.description AS fin_year FROM efin_budgetint bint, c_year yr, c_invoiceline invl, c_invoice inv_1 JOIN (SELECT DISTINCT a.c_invoice_id, trunc(a.created) AS created, a.seqno FROM efin_purchasein_app_hist a) hist ON inv_1.c_invoice_id = hist.c_invoice_id JOIN (SELECT h.c_invoice_id, max(h.seqno) AS seqno FROM efin_purchasein_app_hist h GROUP BY h.c_invoice_id) hist1 ON hist.c_invoice_id = hist1.c_invoice_id AND hist.seqno = hist1.seqno WHERE inv_1.c_invoice_id = invl.c_invoice_id AND bint.efin_budgetint_id = inv_1.em_efin_budgetint_id AND bint.c_year_id = yr.c_year_id AND (inv_1.docstatus IN ('CO', 'EFIN_WFA', 'DR')) UNION ALL SELECT fa.account_id AS em_efin_c_elementvalue_id, gl.docstatus, abs(gll.amtsourcedr - gll.amtsourcecr) AS linenetamt, gl.datedoc AS dateinvoiced, gl.documentno, trunc(appr_hist.approved_date) AS approved_date, yr.description AS fin_year FROM efin_budgetint bint, c_year yr, gl_journal gl, gl_journalline gll, fact_acct fa, (SELECT max(appr.approveddate) AS approved_date, appr.gl_journal_id FROM eut_journal_approval appr GROUP BY appr.gl_journal_id) appr_hist WHERE gl.gl_journal_id = gll.gl_journal_id AND gl.gl_journal_id = appr_hist.gl_journal_id AND gl.documentno = fa.em_efin_documentno AND fa.account_id = gll.em_efin_account AND bint.efin_budgetint_id = gl.em_efin_budgetint_id AND bint.c_year_id = yr.c_year_id AND fa.em_efin_acctseq IS NOT NULL AND gl.em_efin_adj_invoice = 'N') inv ON e.c_elementvalue_id = inv.em_efin_c_elementvalue_id WHERE 1 = 1 AND e.accounttype = 'E' GROUP BY e.em_efin_main_classification, e.em_efin_classification_ar, inv.docstatus, inv.fin_year) main GROUP BY main.em_efin_classification_ar, main.fin_year ORDER BY (CASE WHEN main.em_efin_classification_ar IS NULL THEN 'أخرى' ELSE main.em_efin_classification_ar END)]]></view>
  </database>
